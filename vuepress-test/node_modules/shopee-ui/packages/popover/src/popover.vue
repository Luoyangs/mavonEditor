<template>
  <div :class="[prefixClass, prefixClass + '--' + theme]" v-shopee-clickoutside="handleClickoutside"><!--
 --><div :class="prefixClass + '__ref'" ref="popperRef"><slot></slot></div>
    <shopee-popper
      :class="popperClasses"
      ref="popper"
      :style="style"
      :visible="visible"
      :placement="placement"
      :flippable="popperFlippable"
      :limited-flip="popperLimitedFlip"
      :append-to-body="appendToBody"
      transition-name="zoom-fast">
      <div :class="prefixClass + '__content'">
        <slot name="content" v-if="$slots.content && $slots.content.length > 0"></slot>
        <template v-else>{{content}}</template>
      </div>
    </shopee-popper>
  </div>
</template>
<script>
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';
import { PopperMixin } from 'shopee-ui/lib/base';
import { ShopeeClickoutside } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeePopover',
  directives: {ShopeeClickoutside},
  components: {
    ShopeePopper
  },
  mixins: [PopperMixin],
  props: {
    value: {},
    disabled: Boolean,
    placement: {
      default: 'top'
    },
    trigger: {
      type: String,
      default: 'click',
      validator(value) {
        return ['click', 'hover', 'focus'].indexOf(value) !== -1;
      }
    },
    content: String,
    theme: {
      type: String,
      default: 'light',
      validator(value = 'light') {
        return ['dark', 'light'].indexOf(value) !== -1;
      }
    },
    maxWidth: {
      type: Number,
      default: 320
    },
    withArrow: {
      type: Boolean,
      default: true
    },
    delay: {
      type: Number,
      default: 200
    },
    hideOnClick: {
      type: Boolean,
      default: true
    },
    hideHoverPopper: Boolean
  },
  data() {
    return {
      prefixClass: 'shopee-popover',
      visible: false,
      timeout: null,
    };
  },
  computed: {
    style() {
      return {
        'max-width': this.maxWidth + 'px',
        ...this.popperStyle
      };
    },
    popperClasses() {
      let popperClass = [];
      if (this.popperClass) {
        if (typeof this.popperClass === 'string') {
          popperClass = [this.popperClass];
        } else {
          popperClass = this.popperClass;
        }
      }
      return [
        this.prefixClass + '__popper',
        this.prefixClass + '__popper--' + this.theme,
        this.withArrow && 'with-arrow',
        ...popperClass
      ];
    }
  },
  watch: {
    value: {
      handler(val) {
        if (val) {
          this.show();
        } else {
          this.hide();
        }
      },
      immediate: true
    },
    visible(val) {
      if (val) {
        this.$emit('show');
      } else {
        this.$emit('hide');
      }
    }
  },
  mounted() {
    if (this.value === undefined) {
      this.initEvent();
    }
  },
  beforeDestory() {
    if (this.value === undefined) {
      this.removeEvent();
    }
  },
  methods: {
    show() {
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      this.timeout = setTimeout(() => {
        this.visible = true;
      }, this.delay);
    },
    hide() {
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      this.timeout = setTimeout(() => {
        this.visible = false;
      }, 200);
    },
    handleClick() {
      if (!this.visible) {
        this.handleShow();
      } else if (this.hideOnClick) {
        this.handleHide();
      }
    },
    handleClickoutside(event) {
      this.$emit('clickoutside', event);
      this.handleHide();
    },
    handleShow() {
      if (this.disabled) {
        return;
      }
      if (this.value !== undefined) {
        return;
      }
      this.show();
    },
    handleHide() {
      if (this.value !== undefined) {
        return;
      }
      this.hide();
    },
    initEvent() {
      const triggerElem = this.$refs.popperRef;
      const popperElem = this.$refs.popper.$el;
      switch (this.trigger) {
        case 'click':
          triggerElem.addEventListener('click', this.handleClick);
          break;
        case 'hover':
          triggerElem.addEventListener('mouseenter', this.handleShow);
          triggerElem.addEventListener('mouseleave', this.handleHide);
          if (!this.hideHoverPopper) {
            popperElem.addEventListener('mouseenter', this.handleShow);
            popperElem.addEventListener('mouseleave', this.handleHide);
          }
          break;
        case 'focus':
          triggerElem.addEventListener('mousedown', this.handleShow);
          triggerElem.addEventListener('mouseup', this.handleHide);
          break;
      }
    },
    removeEvent() {
      const triggerElem = this.$refs.popperRef;
      const popperElem = this.$refs.popper.$el;
      switch (this.trigger) {
        case 'click':
          triggerElem.removeEventListener('click', this.handleClick);
          break;
        case 'hover':
          triggerElem.removeEventListener('mouseenter', this.handleShow);
          triggerElem.removeEventListener('mouseleave', this.handleHide);
          popperElem.removeEventListener('mouseenter', this.handleShow);
          popperElem.removeEventListener('mouseleave', this.handleHide);
          break;
        case 'focus':
          triggerElem.removeEventListener('mousedown', this.handleShow);
          triggerElem.removeEventListener('mouseup', this.handleHide);
          break;
      }
    }
  }
};
</script>
