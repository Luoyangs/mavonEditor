<template>
  <div :class="className" ref="popperRef" v-shopee-clickoutside="onClickoutside">
    <slot></slot>
    <slot name="dropdown"></slot>
  </div>
</template>
<script>
import { ShopeeClickoutside, EventBusMixin } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeeDropdown',
  model: {
    prop: 'visible',
    event: 'visible-change'
  },
  directives: {ShopeeClickoutside},
  mixins: [EventBusMixin],
  props: {
    trigger: {
      type: String,
      default: 'click',
      validator(val) {
        return ['click', 'hover', 'contextMenu'].indexOf(val) !== -1;
      }
    },
    showTimeout: {
      type: Number,
      default: 250
    },
    hideTimeout: {
      type: Number,
      default: 150
    },
    hideOnClick: {
      type: Boolean,
      default: true
    },
    visible: {
      type: Boolean,
      default: undefined
    },
    disabled: Boolean
  },
  data() {
    return {
      prefixClass: 'shopee-dropdown',
      actualVisible: false,
      timeout: -1
    };
  },
  computed: {
    className() {
      return [
        this.prefixClass
      ];
    }
  },
  watch: {
    actualVisible(val) {
      this.broadcast('ShopeeDropdownMenu', 'visible-change', val);
      this.$emit('visible-change', val);
    }
  },
  mounted() {
    this.$on('dropdown-menu-click', () => {
      if (this.hideOnClick) {
        this.$nextTick(() => {
          this.hide();
        });
      }
      // for nesting dropdown
      this.dispatch('ShopeeDropdown', 'dropdown-menu-click');
    });

    // init event or control by visible
    if (this.visible !== undefined) {
      this.$watch('visible', (val) => {
        this.actualVisible = val;
      }, { immediate: true });
    } else {
      this.$watch('disabled', val => {
        if (!val) {
          this.initEvent();
        } else {
          this.removeEvent();
        }
      }, { immediate: true });
    }
  },
  beforeDestory() {
    this.removeEvent();
  },
  methods: {
    show() {
      if (this.visible !== undefined) {
        return;
      }
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      this.timeout = setTimeout(() => {
        this.actualVisible = true;
      }, this.showTimeout);
    },
    hide() {
      if (this.visible !== undefined) {
        return;
      }
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      this.timeout = setTimeout(() => {
        this.actualVisible = false;
      }, this.hideTimeout);
    },
    toogle() {
      if (this.actualVisible) {
        this.hide();
      } else {
        this.show();
      }
    },
    onClickRight(event) {
      event.preventDefault();
      this.toogle();
    },
    onClickoutside(event) {
      this.$emit('clickoutside', event);
      this.hide();
    },
    initEvent() {
      const triggerElem = this.$slots.default && this.$slots.default[0].elm;
      const dropdownElem = this.$slots.dropdown && this.$slots.dropdown[0].elm;
      if (!triggerElem || !dropdownElem) {
        return;
      }
      if (this.trigger === 'click') {
        triggerElem.addEventListener('click', this.toogle);
      } else if (this.trigger === 'hover') {
        triggerElem.addEventListener('mouseenter', this.show);
        triggerElem.addEventListener('mouseleave', this.hide);
        dropdownElem.addEventListener('mouseenter', this.show);
        dropdownElem.addEventListener('mouseleave', this.hide);
      } else if (this.trigger === 'contextMenu') {
        triggerElem.addEventListener('contextmenu', this.onClickRight);
      }
    },
    removeEvent() {
      const triggerElem = this.$slots.default && this.$slots.default[0].elm;
      const dropdownElem = this.$slots.default && this.$slots.dropdown[0].elm;
      if (!triggerElem || !dropdownElem) {
        return;
      }
      if (this.trigger === 'click') {
        triggerElem.removeEventListener('click', this.toogle);
      } else if (this.trigger === 'hover') {
        triggerElem.removeEventListener('mouseenter', this.show);
        triggerElem.removeEventListener('mouseleave', this.hide);
        dropdownElem.removeEventListener('mouseenter', this.show);
        dropdownElem.removeEventListener('mouseleave', this.hide);
      } else if (this.trigger === 'contextMenu') {
        triggerElem.removeEventListener('contextmenu', this.onClickRight);
      }
    }
  }
};
</script>
