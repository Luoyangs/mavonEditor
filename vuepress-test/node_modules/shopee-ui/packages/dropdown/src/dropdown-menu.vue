<template>
  <shopee-popper
    ref="popper"
    :class="popperClass"
    :visible="visible"
    :placement="placement"
    :flippable="popperFlippable"
    :flipVariationsByContent="flipVariationsByContent"
    :append-to-body="appendToBody"
    :popper-ref="popperRef">
    <ul class="shopee-dropdown-menu" :style="fullWidth ? {
      'min-width': minWidth,
      'max-width': maxWidth
    } : { 'max-width': maxWidth }">
      <slot></slot>
    </ul>
  </shopee-popper>
</template>
<script>
import { EventBusMixin, PopperMixin } from 'shopee-ui/lib/base';
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';

export default {
  name: 'ShopeeDropdownMenu',
  components: {
    ShopeePopper
  },
  mixins: [EventBusMixin, PopperMixin],
  props: {
    placement: {
      default: 'bottom-start'
    },
    flipVariationsByContent: {
      type: Boolean,
      default: true
    },
    fullWidth: Boolean,
    fixWidth: Boolean
  },
  data() {
    return {
      prefixClass: 'shopee-dropdown-menu',
      popper: null,
      visible: false,
      minWidth: '',
      maxWidth: '440px'
    };
  },
  created() {
    this.$on('dropdown-item-click', item => {
      this.dispatch('ShopeeDropdown', 'dropdown-menu-click');
      this.$emit('click', item.name);
    });
    this.$on('visible-change', visible => {
      // caculate minWidth before visible change
      if (visible && this.fullWidth) {
        const popperRef = this.$refs.popper.computedPopperRef;
        if (popperRef) {
          const refWidth = popperRef.getBoundingClientRect().width + 'px';
          this.minWidth = refWidth;
          if (this.fixWidth) {
            this.maxWidth = refWidth;
          }
        }
      }
      this.$nextTick(() => {
        this.visible = visible;
      });
    });
  }
};
</script>

