<template>
  <div :class="prefixClass">
    <div :class="[prefixClass + '__body']">
      <div :class="[prefixClass + '__date']">
        <shopee-picker-header
          :year="year"
          :month="month"
          :year-range="yearRange"
          :view="view"
          @year-click="changeView('year')"
          @month-click="changeView('month')"
          @next="next"
          @prev="prev"></shopee-picker-header>
        <shopee-date-table
          v-if="type !== 'year' && type !== 'month'"
          v-show="view === 'date'"
          :selection="selection"
          :selecting-range="selectingRange"
          :year="year"
          :month="month"
          :min="min"
          :max="max"
          :disabled-date="disabledDate"
          :show-overflow-date="showOverflowDate"
          :start-of-week="startOfWeek"
          @input="onDateInput"
          @selecting-range-update="onSelectingRangeUpdate"
          @enter-table="onEnterTable"
          @leave-table="onLeaveTable"></shopee-date-table>
        <shopee-month-table
          v-if="type !== 'year'"
          v-show="view === 'month'"
          :value="selection.date || selection.startDate"
          :year="year"
          :min="minMonth"
          :max="maxMonth"
          @input="onMonthInput"></shopee-month-table>
        <shopee-year-table
          v-show="view === 'year'"
          :value="selection.date || selection.startDate"
          :range="yearRange"
          :month="month"
          :min="minMonth"
          :max="maxMonth"
          @input="onYearInput"></shopee-year-table>
      </div>
      <div :class="[prefixClass + '__time']" v-if="showTime">
        <shopee-time-picker-panel
          ref="timePickerPanel"
          v-model="time"
          v-bind="timePickerProps"
        ></shopee-time-picker-panel>
      </div>
    </div>
    <!-- date picker footer -->
    <div :class="prefixClass + '__footer'" v-if="showTime">
      <shopee-button type="primary" size="small" @click="onConfirm" :disabled="disabledConfirm">{{t('shopee-ui.date-picker.confirm')}}</shopee-button>
    </div>
  </div>
</template>

<script>
import { Button as ShopeeButton } from 'shopee-ui/lib/button';
import { TimePicker as ShopeeTimePicker } from 'shopee-ui/lib/time-picker';
import ShopeePickerHeader from '../basic/picker-header.vue';
import ShopeeDateTable from '../basic/date-table.vue';
import ShopeeMonthTable from '../basic/month-table.vue';
import ShopeeYearTable from '../basic/year-table.vue';
import { EventBusMixin, LocaleMixin } from 'shopee-ui/lib/base';
import * as Util from '../utils/util';

export default {
  name: 'ShopeeDatePickerPanel',
  components: {
    ShopeePickerHeader,
    ShopeeButton,
    ShopeeDateTable,
    ShopeeMonthTable,
    ShopeeYearTable,
    ShopeeTimePickerPanel: ShopeeTimePicker.panel
  },
  mixins: [EventBusMixin, LocaleMixin],
  props: {
    value: {},
    // `date`/`month`/`year`/`week`/`datetime`
    type: {
      type: String,
      default: 'date'
    },
    min: Date,
    max: Date,
    disabledDate: Function,
    showOverflowDate: {
      type: Boolean,
      default: true,
    },
    // start of week: 0 stands for Sunday and 6 stands for Saturday
    startOfWeek: {
      type: Number,
      default: 0,
      validator(val) {
        return val <= 6 && val >= 0;
      }
    },
    timePickerProps: Object
  },
  data() {
    return {
      prefixClass: 'shopee-date-picker-panel',
      month: null,
      year: null,
      selection: {},
      selectingRange: {},
      time: '',
      view: 'date',
      viewHistory: [],
      yearRange: Util.getYearRange(this.year),
      unwatch: null
    };
  },
  computed: {
    disabledConfirm() {
      return !this.selection.date;
    },
    showTime() {
      return this.type.indexOf('time') > -1;
    },
    minMonth() {
      if (this.min && Util.isValidDate(this.min)) {
        return {
          year: this.min.getFullYear(),
          month: this.min.getMonth()
        };
      }
    },
    maxMonth() {
      if (this.max && Util.isValidDate(this.max)) {
        return {
          year: this.max.getFullYear(),
          month: this.max.getMonth()
        };
      }
    }
  },
  watch: {
    type() {
      this.resetView();
    },
    value() {
      this.resetView();
    },
    'selection.date': function (date) {
      // update year and month when selection.date updated
      this.year = (date && date.getFullYear) ?
        date.getFullYear() :
        new Date().getFullYear();
      this.month = (date && date.getMonth) ?
        date.getMonth() :
        new Date().getMonth();
    },
    'selection.startDate': function (date) {
      // update year and month when selection.date updated
      this.year = (date && date.getFullYear) ?
        date.getFullYear() :
        new Date().getFullYear();
      this.month = (date && date.getMonth) ?
        date.getMonth() :
        new Date().getMonth();
    },
    year(val) {
      // update yearRange when year updated
      const year = Number(val);
      this.yearRange = Util.getYearRange(year);
    }
  },
  mounted() {
    this.resetView();
    if (this.$scopedSlots.dateCell) {
      this.broadcast('ShopeeDateTable', 'add-date-cell-slot', this.$scopedSlots.dateCell);
    }
    this.unwatch = this.$watch(() => `${this.month + 1}/${this.year}`, (val) => {
      this.$emit('date-view-change', val);
    });
  },
  beforeDestroy() {
    if (this.unwatch) {
      this.unwatch();
    }
  },
  methods: {
    next(type) {
      switch (this.view) {
        case 'month': {
          this.year = ++this.year;
          break;
        }
        case 'year': {
          const { start, end } = this.yearRange;
          this.yearRange = {
            start: start + 10,
            end: end + 10
          };
          break;
        }
        case 'date': {
          if (type === 'month') {
            const nextMonth = Util.nextMonth(this.year, this.month);
            this.month = nextMonth.month;
            this.year = nextMonth.year;
          } else {
            this.year = ++this.year;
          }
          break;
        }
      }
    },
    prev(type) {
      switch (this.view) {
        case 'month': {
          this.year = --this.year;
          break;
        }
        case 'year': {
          const { start, end } = this.yearRange;
          this.yearRange = {
            start: start - 10,
            end: end - 10
          };
          break;
        }
        case 'date': {
          if (type === 'month') {
            const lastMonth = Util.lastMonth(this.year, this.month);
            this.month = lastMonth.month;
            this.year = lastMonth.year;
          } else {
            this.year = --this.year;
          }
          break;
        }
      }
    },
    onDateInput(date) {
      if (!this.showTime) {
        this.emit(date);
      } else {
        // update selection.date
        this.selection.date = date;
      }
    },
    onSelectingRangeUpdate(selectingRange) {
      if (this.type === 'week') {
        this.selectingRange = {
          ...selectingRange,
          active: true,
        };
      }
    },
    onEnterTable() {
      if (this.selectingRange.startDate || this.selectingRange.endDate) {
        this.selectingRange = {
          ...this.selectingRange,
          active: true
        };
      }
    },
    onLeaveTable() {
      this.selectingRange = {
        ...this.selectingRange,
        active: false
      };
    },
    onMonthInput(month) {
      this.month = month;
      if (this.type === 'month') {
        const date = new Date((this.selection.date || new Date()).getTime());
        date.setFullYear(this.year);
        date.setMonth(this.month);
        this.emit(date);
      } else {
        this.changeView();
      }
    },
    onYearInput(year) {
      this.year = year;
      if (this.type === 'year') {
        const date = new Date((this.selection.date || new Date()).getTime());
        date.setFullYear(year);
        this.emit(date);
      } else {
        this.changeView();
      }
    },
    changeView(view) {
      if (view) {
        this.viewHistory.push(this.view);
        this.view = view;
      } else {
        const lastView = this.viewHistory.pop();
        this.view = lastView;
      }
    },
    resetView() {
      const type = this.type;
      let value = this.value;
      let selection;
      let date;
      if (type === 'week') {
        value = value || {};
        selection = {
          type: 'week',
          startDate: value.startDate ? new Date(value.startDate) : value.startDate,
          endDate: value.endDate ? new Date(value.endDate) : value.endDate
        };
        date = selection.startDate || new Date();
      } else {
        selection = {
          type: 'date',
          date: value ? new Date(value) : value
        };
        date = selection.date || new Date();
      }

      this.selection = selection;
      this.year = date.getFullYear();
      this.month = date.getMonth();
      this.time = date;
      if (this.showTime) {
        // for type update, timePickerPanel can access next tick
        if (this.$refs.timePickerPanel) {
          this.$refs.timePickerPanel.resetView();
        }
      }

      this.view = (type === 'month' || type === 'year') ? type : 'date';
    },
    onConfirm() {
      this.selection.date.setHours(this.time.getHours());
      this.selection.date.setMinutes(this.time.getMinutes());
      this.selection.date.setSeconds(this.time.getSeconds());
      this.emit(this.selection.date);
    },
    emit(date) {
      // for v-model
      this.$emit('input', date);
      if (this.type !== 'week') {
        if (date.getTime() !== new Date(this.value).getTime()) {
          this.$emit('change', date);
        }
      } else {
        const { startDate, endDate } = this.value;
        if (
          !(
            startDate &&
            endDate &&
            startDate.getTime() === date.startDate.getTime() &&
            endDate.getTime() === date.endDate.getTime()
          )
        ) {
          this.$emit('change', date);
        }
      }
    }
  }
};
</script>
