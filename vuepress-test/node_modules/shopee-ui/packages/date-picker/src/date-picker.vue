<template>
  <div class="shopee-date-picker" v-shopee-clickoutside="hidePicker">
    <div class="shopee-date-picker__input" ref="popperRef">
      <shopee-selector
        ref="input"
        :size="size"
        :value="displayValue"
        :disabled="disabled"
        :clearable="clearable"
        :placeholder="placeholder"
        :prefix-icon="calendarIcon"
        @clear="clear()"
        @click="toggleVisible()"></shopee-selector>
    </div>
    <shopee-popper
      ref="popper"
      class="shopee-date-picker__picker"
      :class="popperClass"
      :visible="visible"
      :placement="placement"
      :flippable="popperFlippable"
      :append-to-body="appendToBody">
      <shopee-date-shortcuts
        v-if="shortcuts"
        :shortcuts="shortcuts"
        :format="format"
        @active-change="onShortcutActiveChange"
        @input="onPickerInput"
      ></shopee-date-shortcuts>
      <shopee-date-picker-panel
        v-if="!isRange(innerType)"
        v-show="activedShortcut"
        ref="picker"
        :type="innerType"
        :value="innerValue"
        :min="min"
        :max="max"
        :disabled-date="disabledDate"
        :show-overflow-date="showOverflowDate"
        :start-of-week="startOfWeek"
        :time-picker-props="innerTimePickerProps"
        @input="onPickerInput"
        @change="onPickerChange"
        ></shopee-date-picker-panel>
      <shopee-date-range-picker-panel
        v-else
        v-show="activedShortcut"
        ref="picker"
        :type="innerType"
        :value="innerRangeValue"
        :min="min"
        :max="max"
        :fixed="fixed"
        :disabled-date="disabledDate"
        :show-overflow-date="showOverflowDate"
        :start-of-week="startOfWeek"
        :time-picker-props="innerTimePickerProps"
        @input="onPickerInput"
        @change="onPickerChange"
        @range-input="onPickerRangeInput"
        ></shopee-date-range-picker-panel>
    </shopee-popper>
  </div>
</template>
<script>
import fecha from 'fecha';
import { ShopeeClickoutside, EventBusMixin, PopperMixin } from 'shopee-ui/lib/base';
import { Selector as ShopeeSelector } from 'shopee-ui/lib/selector';
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';
import ShopeeDateShortcuts from './date-shortcuts.vue';
import ShopeeDatePickerPanel from './panels/date-picker.vue';
import ShopeeDateRangePickerPanel from './panels/daterange-picker.vue';
import calendarIcon from '@shopee-ui/icon/svg/calendar.svg';

const DATE_FORMAT = 'DD/MM/YYYY';
const DATETIME_FORMAT = 'DD/MM/YYYY HH:mm';
const YEAR_FORMAT = 'YYYY';
const MONTH_FORMAT = 'MM/YYYY';

export default {
  name: 'ShopeeDatePicker',
  directives: {ShopeeClickoutside},
  components: {
    ShopeePopper,
    ShopeeSelector,
    ShopeeDateShortcuts,
    ShopeeDatePickerPanel,
    ShopeeDateRangePickerPanel
  },
  mixins: [EventBusMixin, PopperMixin],
  props: {
    value: {},
    /**
     * select type:
     * `date`/`month`/`year`
     * `daterange`/`monthrange`/`yearrange`/`week`
     * `datetime`/`datetimerange`
     */
    type: {
      type: String,
      default: 'date'
    },
    // size of input: x-large, large, normal, small
    size: String,
    disabled: Boolean,
    clearable: {
      type: Boolean,
      default: true
    },
    shortcuts: Array,
    min: [Date, Function],
    max: [Date, Function],
    disabledDate: Function,
    format: {
      type: [String, Function],
      default() {
        if (this.type.indexOf('time') !== -1) {
          return DATETIME_FORMAT;
        } else if (this.type === 'month') {
          return MONTH_FORMAT;
        } else if (this.type === 'year') {
          return YEAR_FORMAT;
        } else {
          return DATE_FORMAT;
        }
      }
    },
    rangeSeparator: {
      type: String,
      default: ' â€“ '
    },
    // start of week: 0 stands for Sunday and 6 stands for Saturday
    startOfWeek: {
      type: Number,
      default: 0,
      validator(val) {
        return val <= 6 && val >= 0;
      }
    },
    placeholder: String,
    showOverflowDate: {
      type: Boolean,
      default() {
        if (this.type.indexOf('range') > -1 || this.type === 'week') {
          return false;
        } else {
          return true;
        }
      }
    },
    placement: {
      default: 'bottom-start'
    },
    // fixed of daterange picker: false, start, end
    fixed: [Boolean, String],
    timePickerProps: Object
  },
  data() {
    return {
      calendarIcon,
      visible: false,
      selectedShortcut: null,
      activedShortcut: {
        type: this.type
      }
    };
  },
  computed: {
    innerValue() {
      if (!this.isRange(this.innerType)) {
        if (this.selectedShortcut ? this.selectedShortcut.type === this.innerType : this.activedShortcut) {
          return this.value;
        }
      }
      return this.innerType === 'week' ? {} : '';
    },
    innerRangeValue() {
      if (this.isRange(this.innerType)) {
        if (this.selectedShortcut ? this.selectedShortcut.type === this.innerType : this.activedShortcut) {
          return this.value;
        }
      }
      return {};
    },
    innerType() {
      return this.activedShortcut ? this.activedShortcut.type : this.type;
    },
    innerTimePickerProps() {
      let timePickerProps = this.timePickerProps || {};
      if (this.innerType === 'datetimerange') {
        timePickerProps = {
          start: timePickerProps.start || timePickerProps,
          end: timePickerProps.end || timePickerProps
        };
      }
      if (typeof this.format === 'string') {
        const matches = this.format.match(/.*(HH(:mm(:ss)?)?).*/);
        if (matches) {
          const timeFormat = matches[1];
          if (this.innerType === 'datetimerange') {
            timePickerProps.start.format = timePickerProps.start.format || timeFormat;
            timePickerProps.end.format = timePickerProps.end.format || timeFormat;
          } else {
            timePickerProps.format = timePickerProps.format || timeFormat;
          }
        }
      }
      return timePickerProps;
    },
    displayValue() {
      if (!this.value) {
        return '';
      }
      if (this.selectedShortcut && this.selectedShortcut.isCustom) {
        const type = this.selectedShortcut.type;
        const format = this.selectedShortcut.format || this.getDefaultFormat(type);
        return this.formatValue(type, format, this.value);
      } else {
        return this.formatValue(this.type, this.format, this.value);
      }
    }
  },
  mounted() {
    if (this.$scopedSlots.dateCell) {
      this.broadcast('ShopeeDateTable', 'add-date-cell-slot', this.$scopedSlots.dateCell);
    }
  },
  methods: {
    clear() {
      if (this.isRange(this.innerType)) {
        this.$emit('input', {});
        this.$emit('change', {});
      } else {
        this.$emit('input', '');
        this.$emit('change', '');
      }
      this.hidePicker();
    },
    onShortcutActiveChange(value) {
      if (value && value.type) {
        this.activedShortcut = value;
      } else {
        this.activedShortcut = null;
      }
    },
    onPickerInput(value) {
      this.$emit('input', value);
      this.selectedShortcut = this.activedShortcut;
      this.hidePicker();
    },
    onPickerChange(value) {
      this.$emit('change', value);
      this.dispatch('ShopeeFormItem', 'field-change', value);
    },
    onPickerRangeInput(value) {
      this.$emit('range-input', value);
    },
    showPicker() {
      this.visible = true;
      this.$nextTick(() => {
        if (this.$refs.picker) {
          this.$refs.picker.resetView();
        }
      });
    },
    hidePicker() {
      if (this.visible) {
        this.visible = false;
        this.dispatch('ShopeeFormItem', 'field-blur', this.value);
      }
    },
    toggleVisible() {
      if (this.disabled) {
        return;
      }
      if (this.visible) {
        this.hidePicker();
      } else {
        this.showPicker();
      }
    },
    isRange(type) {
      return type && type.indexOf('range') > -1;
    },
    getDefaultFormat(type) {
      if (type.indexOf('time') !== -1) {
        return DATETIME_FORMAT;
      } else if (type === 'month') {
        return MONTH_FORMAT;
      } else if (type === 'year') {
        return YEAR_FORMAT;
      } else {
        return DATE_FORMAT;
      }
    },
    formatValue(type, format, value) {
      let label = '';
      if (typeof format === 'function') {
        label = format(value);
      } else {
        if (type.indexOf('range') > -1 || type === 'week') {
          if (value.startDate && value.endDate) {
            label = `${fecha.format(value.startDate, format)}${this.rangeSeparator}${fecha.format(value.endDate, format)}`;
          }
        } else {
          label = fecha.format(value, format);
        }
      }
      return label;
    }
  }
};
</script>
