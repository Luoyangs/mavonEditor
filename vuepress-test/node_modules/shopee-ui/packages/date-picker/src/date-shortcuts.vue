<template>
  <ul
    :class="[prefixClass + '-list', {
     'with-display-text': withCustomDateType && activedShortcut && !activedShortcut.type
    }]">
    <template v-for="(shortcut, index) in filterShortcuts">
      <li :key="index" :class="prefixClass + '-split'" v-if="shortcut.type === 'split'"></li>
      <li v-else
        :key="index"
        :class="[prefixClass + '-item', {
          'with-picker': shortcut.type,
          'active': activedShortcut === shortcut
        }]"
        @mouseenter="onMouseenter(shortcut)"
        @click="onShortcutClick(shortcut)">
        <span :class="prefixClass + '-item__text'">{{shortcut.text}}</span>
        <shopee-icon :svg="arrowRightIcon" v-if="shortcut.type"></shopee-icon>
        <span :class="prefixClass + '-item__display'" v-else-if="withCustomDateType">{{getShortcutHoverText(shortcut)}}</span>
      </li>
    </template>
  </ul>
</template>

<script>
import fecha from 'fecha';
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import arrowRightIcon from '@shopee-ui/icon/svg/arrow-right.svg';

export default {
  name: 'ShopeeDateShortcuts',
  components: {
    ShopeeIcon
  },
  props: {
    shortcuts: Array,
    format: [String, Function],
    rangeSeparator: String,
  },
  data() {
    return {
      arrowRightIcon,
      prefixClass: 'shopee-date-shortcut',
      datePickerType: ['date', 'month', 'year', 'week', 'daterange'],
      activedShortcut: null,
      toActiveShortcut: null,
      mouseMoveTimeout: null
    };
  },
  computed: {
    withCustomDateType() {
      return this.shortcuts && this.shortcuts.some(item => this.datePickerType.indexOf(item.type) > -1);
    },
    filterShortcuts() {
      if (!this.shortcuts) {
        return;
      }
      return this.shortcuts
        .filter(item => {
          // filter with type
          return !item.type || item.type === 'split' || this.datePickerType.indexOf(item.type) > -1;
        })
        .map(item => {
          return !item.type ? item : {
            ...item,
            isCustom: true,
          };
        });
    }
  },
  mounted() {
    if (this.withCustomDateType) {
      this.onShortcutHover(this.filterShortcuts.find(item => this.datePickerType.indexOf(item.type) > -1));
      // add mousemove listener to active shortcut smoothly
      this.$el.addEventListener('mousemove', this.onMousemove);
      this.$el.addEventListener('mouseleave', this.onMouseleave);
    }
  },
  beforeDestory() {
    if (this.withCustomDateType) {
      this.$el.removeEventListener('mousemove', this.onMousemove);
      this.$el.removeEventListener('mouseleave', this.onMouseleave);
    }
  },
  methods: {
    onMousemove() {
      if (this.mouseMoveTimeout) {
        clearTimeout(this.mouseMoveTimeout);
      }
      const isPickerType = !!(this.toActiveShortcut && this.toActiveShortcut.type);
      this.mouseMoveTimeout = setTimeout(() => {
        this.onShortcutHover(this.toActiveShortcut);
      }, isPickerType ? 20 : 0);
    },
    onMouseleave() {
      if (this.mouseMoveTimeout) {
        clearTimeout(this.mouseMoveTimeout);
      }
    },
    onMouseenter(shortcut) {
      this.toActiveShortcut = shortcut;
    },
    onShortcutHover(shortcut) {
      if (this.withCustomDateType) {
        if (shortcut !== this.activedShortcut) {
          this.activedShortcut = shortcut;
          this.$emit('active-change', this.activedShortcut);
        }
      }
    },
    async onShortcutClick(shortcut) {
      if (shortcut.value && !shortcut.type) {
        let value = shortcut.value;
        if (typeof value === 'function') {
          value = await value();
        }
        this.$emit('input', value);
      }
    },
    getShortcutHoverText(shortcut) {
      if (!shortcut.value) {
        return '';
      }
      const value = shortcut.value;
      let label = '';
      if (typeof this.format === 'function') {
        label = this.format(value);
      } else {
        if (value.startDate && value.endDate) {
          label = `${fecha.format(value.startDate, this.format)}${this.rangeSeparator}${fecha.format(value.endDate, this.format)}`;
        } else {
          label = fecha.format(value, this.format);
        }
      }
      return label;
    }
  }
};
</script>
