<template>
  <div :class="className">
    <shopee-cascader-menu
      containerType='panel'
      :lists="showLists"
      :selected="currentSelected"
      :max-height="maxHeight"
      :section-index="showSectionStart"
      :menuStyle="{width: menuMaxWidth + 'px'}"
      :max-width="menuMaxWidth"
      :max-show-limit="maxShowLimit"
      @item-select="onMenuItemSelect">
    </shopee-cascader-menu>
    <div class="arrow left" @click="changeLevel(-1)" v-show="showSectionStart > 0">
      <shopee-icon :svg="arrowLeftIcon" class="icon"></shopee-icon>
    </div>
    <div class="arrow right" @click="changeLevel(1)" v-show="showSectionStart + maxShowLimit < lists.length">
      <shopee-icon :svg="arrowRightIcon" class="icon"></shopee-icon>
    </div>
  </div>
</template>
<script>
import { EventBusMixin, FormItemMixin } from 'shopee-ui/lib/base';
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import CascaderBaseMixin from './mixins/cascader-base';
import ShopeeCascaderMenu from './cascader-menu.vue';
import { getOptionsMaxLevel, isSelectFinished } from './utils/helper';
import arrowRightIcon from '@shopee-ui/icon/svg/arrow-right.svg';
import arrowLeftIcon from '@shopee-ui/icon/svg/arrow-left.svg';

export default {
  name: 'ShopeeCascaderPanel',
  components: {
    ShopeeCascaderMenu,
    ShopeeIcon
  },
  mixins: [EventBusMixin, FormItemMixin, CascaderBaseMixin],
  props: {
    maxShowLimit: {
      type: Number,
      default: 5
    },
    maxHeight: {
      type: Number,
      default: 218
    },
    menuMaxWidth: { // menu的宽度，超过此宽度就折行显示，默认150
      type: Number,
      default: 150
    }
  },
  data() {
    return {
      prefixClass: 'shopee-cascader-panel',
      trigger: 'click',
      showSectionStart: 0,
      arrowLeftIcon,
      arrowRightIcon
    };
  },
  computed: {
    className() {
      return [
        this.prefixClass
      ];
    },
    showLists() {
      if (this.lists.length <= this.maxShowLimit) {
        return this.lists;
      }
      const end = Math.min(this.lists.length, this.showSectionStart + this.maxShowLimit);
      return this.lists.slice(this.showSectionStart, end);
    },
    maxLevel() {
      return getOptionsMaxLevel(this.options);
    }
  },
  methods: {
    emitCurrentSelect() {
      // emit change
      if (this.changeOnSelect) {
        this.emit(this.currentSelected);
      } else if (isSelectFinished(this.options, this.currentSelected)) {
        this.emit(this.currentSelected);
      }
    },
    resetCurrentSelected(option) {
      if (this.currentSelected[option.level] !== undefined) {
        // reset selected value
        const listsOriginLength = this.lists.length;
        this.currentSelected = this.currentSelected.filter((value, index) => {
          if (index <= option.level) {
            return true;
          }
        });
        this.currentSelected.splice(option.level, 1, option.value);
        this.$nextTick(() => {
          if (this.showSectionStart + this.maxShowLimit === this.lists.length - 1) {
            this.changeLevel(1);
          } else if (this.lists.length !== listsOriginLength && this.showSectionStart + this.maxShowLimit !== this.lists.length) {
            this.changeLevel(this.lists.length - listsOriginLength);
          }
        });
      } else {
        // add current value to selected value
        this.currentSelected.push(option.value);
        //显示的最后一层展开，需要调整showSectionStart
        this.$nextTick(() => {
          if (this.showSectionStart + this.maxShowLimit === this.lists.length - 1) {
            this.changeLevel(1);
          }
        });
      }
    },
    onMenuItemSelect(option) {
      if (option.trigger === 'click') {
        this.resetCurrentSelected(option);
        this.emitCurrentSelect();
      }
    },
    changeLevel(val) {
      const max = Math.max(0, this.lists.length - this.maxShowLimit);
      const min = 0;
      this.showSectionStart = Math.max(min, Math.min(max, this.showSectionStart + val));
    }
  }
};
</script>
