<template>
  <transition name="move-down-fast">
    <div class="shopee-modal__box" :class="classNames" v-show="visible"><!-- for close-button -->
      <div class="shopee-modal__content"
        :class="{
          ['shopee-modal__content--' + size]: size,
          'shopee-modal__content--center': center
        }"
        :style="{
          width: width && (width + 'px')
        }">
        <slot>
          <div class="shopee-modal__header" v-if="title || hasBack || $slots.header">
            <slot name="header">
              <div class="shopee-modal__header-inner" :class="{
                'shopee-modal__header-inner__has-back': hasBack,
                'shopee-modal__header-inner__has-close': showClose,
                }">
                <shopee-icon :svg="arrowLeftIcon" class="shopee-modal__header-back" @click.native="cancel" v-if="hasBack"></shopee-icon>
                <div class="shopee-modal__title">{{title}}</div>
                <div class="shopee-modal__subtitle" v-if="subtitle">{{subtitle}}</div>
              </div>
            </slot>
          </div>
          <div ref="body" :class="['shopee-modal__body', overHeight && 'over-height']">
            <slot name="content">{{content}}</slot>
          </div>
          <div class="shopee-modal__footer" :class="[$slots['footer-assist'] && 'with-assist']" v-if="showCancel || showConfirm || $slots.footer">
            <slot name="footer">
              <slot name="footer-assist"></slot>
              <div class="shopee-modal__footer-buttons">
                <shopee-button @click="cancel" v-if="showCancel" :disabled="isCancelDisabled" :loading="isCancelLoading">{{localCancelText}}</shopee-button>
                <shopee-button type="primary" v-if="showConfirm" @click="confirm" :disabled="isConfirmDisabled" :loading="isConfirmLoading">{{localConfirmText}}</shopee-button>
              </div>
            </slot>
          </div>
        </slot>
      </div>
      <shopee-icon
        :class="['shopee-modal__close']"
        :svg="closeIcon"
        @click.native="close"
        v-if="showClose"></shopee-icon>
    </div>
  </transition>
</template>

<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { Button as ShopeeButton } from 'shopee-ui/lib/button';
import { addResizeListener, removeResizeListener } from 'shopee-ui/lib/base';
import { LocaleMixin } from 'shopee-ui/lib/base';
import arrowLeftIcon from '@shopee-ui/icon/svg/arrow-left.svg';
import closeIcon from '@shopee-ui/icon/svg/close.svg';

export default {
  name: 'ShopeeModalBox',
  components: {
    ShopeeButton,
    ShopeeIcon
  },
  mixins: [LocaleMixin],
  props: {
    title: String,
    subtitle: String,
    content: String,
    visible: Boolean,
    classNames: {
      type: Array,
      default() {
        return [];
      }
    },
    // size of modal: normal, medium, large and x-large
    size: {
      type: String,
      default: 'normal',
      validator(value = 'normal') {
        return ['x-large', 'large', 'normal', 'medium'].indexOf(value) >= 0;
      }
    },
    width: Number,
    showCancel: {
      type: Boolean,
      default: true
    },
    showConfirm: {
      type: Boolean,
      default: true
    },
    center: Boolean,
    showClose: {
      type: Boolean,
      default: true
    },
    hasBack: Boolean,
    confirmText: String,
    cancelText: String,
    isConfirmDisabled: Boolean,
    isCancelDisabled: Boolean,
    isConfirmLoading: Boolean,
    isCancelLoading: Boolean,
    closeOnClickMask: Boolean,
    closeOnEsc: Boolean,
    emitClose: Boolean,
    locked: Boolean
  },
  inheritAttrs: false,
  data() {
    return {
      arrowLeftIcon,
      closeIcon,
      overHeight: false
    };
  },
  computed: {
    localConfirmText() {
      if (!this.confirmText) {
        return this.t('shopee-ui.modal.confirm');
      } else {
        return this.confirmText;
      }
    },
    localCancelText() {
      if (!this.cancelText) {
        return this.t('shopee-ui.modal.cancel');
      } else {
        return this.cancelText;
      }
    }
  },
  watch: {
    visible(val) {
      if (val) {
        this.$nextTick(() => {
          this.checkHeight();
        });
      }
    }
  },
  mounted() {
    if (this.$refs.body) {
      addResizeListener(this.$refs.body, this.checkHeight);
    }
  },
  beforeDestroy() {
    if (this.$refs.body) {
      removeResizeListener(this.$refs.body, this.checkHeight);
    }
  },
  methods: {
    close(...args) {
      if (this.emitClose) {
        this.$emit('close');
      } else {
        this.cancel(...args);
      }
    },
    confirm(...args) {
      this.$emit('confirm', ...args);
    },
    cancel(...args) {
      this.$emit('cancel', ...args);
    },
    checkHeight() {
      const body = this.$refs.body;
      if (body) {
        if (body.scrollHeight > body.clientHeight) {
          this.overHeight = true;
        } else {
          this.overHeight = false;
        }
      }
    }
  }
};
</script>

<style lang="scss">
</style>
