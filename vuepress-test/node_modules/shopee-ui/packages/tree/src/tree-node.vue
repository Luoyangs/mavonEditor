<template>
  <div
    class="shopee-tree-node"
    @click.stop="handleClick"
    role="treeitem"
    tabindex="-1"
    ref="node"
  >
    <div class="shopee-tree-node__content"
      :class="{
        'is-root': isRoot,
        'is-expanded': expanded,
        'is-current': node.isCurrent,
      }"
      @mouseenter="handleMouseEnter"
      @mouseleave="isHover=false"
      :style="{ 'padding-left': getNodeIndent(node) + 'px' }">
      <shopee-icon class="icon"
        v-if="!node.isLeaf"
        :svg="preIcon"
        :class="{
          'is-expanded': expanded
        }"
        ></shopee-icon>
      <node-content :node="node"
          :show-overflow-tips="showOverflowTips"
          :is-text-overflow="isTextOverflow"
          :is-hover="isHover">
      </node-content>
    </div>
    <shopee-collapse-transition>
      <div
        class="shopee-tree-node__children"
        :class="isAllChildLeaf ? 'all-leaf':''"
        v-if="!renderAfterExpand || childNodeRendered"
        v-show="expanded"
        role="group"
      >
        <shopee-tree-node
          :render-content="renderContent"
          v-for="child in node.childNodes"
          :render-after-expand="renderAfterExpand"
          :show-overflow-tips="showOverflowTips"
          :key="getNodeKey(child)"
          :node="child"
          @node-expand="handleChildNodeExpand">
        </shopee-tree-node>
      </div>
    </shopee-collapse-transition>
  </div>
</template>

<script type="text/jsx">
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { Tooltip as ShopeeTooltip } from 'shopee-ui/lib/tooltip';
import { ShopeeCollapseTransition } from 'shopee-ui/lib/base';
import { EventBusMixin } from 'shopee-ui/lib/base';
import { getNodeKey } from './model/util';
import ARROR_ICON from '@shopee-ui/icon/svg/arrow-right.svg';

const TREENODEINDENT = 20; // 16 （icon宽度） + 4

export default {
  name: 'ShopeeTreeNode',
  componentName: 'ShopeeTreeNode',
  components: {
    ShopeeCollapseTransition,
    ShopeeIcon,
    ShopeeTooltip,
    NodeContent: {
      props: {
        node: {
          required: true
        },
        showOverflowTips: Boolean,
        isTextOverflow: Boolean,
        isHover: Boolean
      },
      components: {
        ShopeeTooltip
      },
      render(h) {
        const parent = this.$parent;
        const tree = parent.tree;
        const node = this.node;
        const showOverflowTips = this.showOverflowTips;
        const isTextOverflow = this.isTextOverflow;
        const isHover = this.isHover;
        const { data, store } = node;
        const tooltipsStyle = {
          display: 'inherit'
        };
        let component = (
          <div class="label">{ node.label }</div>
        );
        if (showOverflowTips) {
          component = (
            <shopee-tooltip content={ node.label } style={ tooltipsStyle } value={ isTextOverflow && isHover } ref="tooltip">
              { component }
            </shopee-tooltip>
          );
        }
        return (
          parent.renderContent ?
            parent.renderContent.call(parent._renderProxy, h, { _self: tree.$vnode.context, node, data, store }) :
            tree.$scopedSlots.default ?
              tree.$scopedSlots.default({ node, data }) : component
        );
      }
    }
  },

  mixins: [EventBusMixin],

  props: {
    node: {
      default() {
        return {};
      }
    },
    renderContent: Function,
    showOverflowTips: {
      type: Boolean,
      default: false
    },
    props: {},
    renderAfterExpand: {
      type: Boolean,
      default: true
    }
  },

  data() {
    return {
      tree: null,
      expanded: false,
      childNodeRendered: false,
      isTextOverflow: false,
      isHover: false,
      preIcon: ARROR_ICON
    };
  },

  computed: {
    isRoot() {
      return !!this.$parent.isTree;
    },
    isAllChildLeaf() {
      const children = this.node.childNodes || [];
      let isAllLeaf = true;
      children.forEach(node => {
        if (node && !node.isLeaf) {
          isAllLeaf = false;
        }
      });
      return isAllLeaf;
    }
  },

  watch: {

    'node.expanded'(val) {
      this.$nextTick(() => this.expanded = val);
      if (val) {
        this.childNodeRendered = true;
      }
    }
  },

  created() {
    const parent = this.$parent;

    if (parent.isTree) {
      this.tree = parent;
    } else {
      this.tree = parent.tree;
    }

    const tree = this.tree;
    if (!tree) {
      console.warn('[ShopeeUI warn][Tree]Can not find node\'s tree.');
    }

    const props = tree.props || {};
    const childrenKey = props.children || 'children';

    this.$watch(`node.data.${childrenKey}`, () => {
      this.node.updateChildren();
    });

    if (this.node.expanded) {
      this.expanded = true;
      this.childNodeRendered = true;
    }

    if (this.tree.accordion) {
      this.$on('tree-node-expand', node => {
        if (this.node !== node) {
          this.node.collapse();
        }
      });
    }
  },

  methods: {

    handleMouseEnter($event) {
      this.isHover = true;
      if (!this.showOverflowTips) {
        return;
      }
      const result = this.checkIsOverflow($event.currentTarget);
      if (result) {
        this.isTextOverflow = true;
      } else {
        this.isTextOverflow = false;
      }

    },


    checkIsOverflow(el) {
      if (!el) {
        return false;
      }
      const shopeeTooltip = el.querySelector('.shopee-tooltip');
      if (!shopeeTooltip) {
        return false;
      }
      const label = shopeeTooltip.querySelector('.label');
      if (!label) {
        return false;
      }
      return label.scrollHeight - label.offsetHeight > 10;
    },

    getNodeKey(node) {
      return getNodeKey(this.tree.nodeKey, node.data);
    },

    getNodeIndent(node) {
      return (node.level - 1) * TREENODEINDENT + 16 + 8;
    },

    handleClick() {
      const store = this.tree.store;
      store.setCurrentNode(this.node);
      this.tree.$emit('current-change', store.currentNode ? store.currentNode.data : null, store.currentNode);
      this.tree.currentNode = this;
      this.expandNode();
      this.tree.$emit('node-click', this.node.data, this.node, this);
    },

    expandNode() {
      if (this.node.isLeaf) {
        return;
      }
      if (this.expanded) {
        this.tree.$emit('node-collapse', this.node.data, this.node, this);
        this.node.collapse();
      } else {
        this.node.expand();
        this.$emit('node-expand', this.node.data, this.node, this);
      }
    },


    handleChildNodeExpand(nodeData, node, instance) {
      this.broadcast('ShopeeTreeNode', 'tree-node-expand', node);
      this.tree.$emit('node-expand', nodeData, node, instance);
    },

  },

};
</script>
