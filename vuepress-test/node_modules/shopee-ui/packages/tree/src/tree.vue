<template>
    <div class="shopee-tree"
      role="tree">
      <shopee-tree-node
        v-for="child in root.childNodes"
        :node="child"
        :props="props"
        :show-overflow-tips="showOverflowTips"
        :render-after-expand="renderAfterExpand"
        :key="getNodeKey(child)"
        :render-content="renderContent"
        @node-expand="handleNodeExpand">
      </shopee-tree-node>
    </div>
</template>
<script>
import TreeStore from './model/tree-store';
import { getNodeKey } from './model/util';
import { EventBusMixin } from 'shopee-ui/lib/base';
import ShopeeTreeNode from './tree-node.vue';

export default {
  name: 'ShopeeTree',
  components: {
    ShopeeTreeNode
  },
  mixins: [EventBusMixin],
  props: {
    data: Array,
    nodeKey: String,
    defaultExpandedKeys: Array,
    // 手风琴样式
    accordion: {
      type: Boolean,
      default: false
    },
    defaultExpandAll: {
      type: Boolean,
      default: false
    },
    // 第一个展开后才渲染
    renderAfterExpand: {
      type: Boolean,
      default: true
    },
    // 展开子节点的时候是否自动展开父节点
    autoExpandParent: {
      type: Boolean,
      default: true
    },
    // 设计要求文案最多显示2行，hover时显示完整文案
    showOverflowTips: {
      type: Boolean,
      default: true
    },
    currentNodeKey: [String, Number],
    renderContent: Function,
    props: {
      type: Object,
      default() {
        return {
          children: 'children',
          label: 'label'
        };
      }
    },
  },
  data() {
    return {
      store: null,
      root: null,
      currentNode: null,
    };
  },

  watch: {
    defaultExpandedKeys(newVal) {
      this.store.defaultExpandedKeys = newVal;
      this.store.setDefaultExpandedKeys(newVal);
    },

    data(newVal) {
      this.store.setData(newVal);
    },
  },

  created() {
    this.isTree = true;

    this.store = new TreeStore({
      key: this.nodeKey,
      data: this.data,
      props: this.props,
      currentNodeKey: this.currentNodeKey,
      defaultExpandedKeys: this.defaultExpandedKeys,
      autoExpandParent: this.autoExpandParent,
      defaultExpandAll: this.defaultExpandAll,
    });

    this.root = this.store.root;
  },

  methods: {

    getNodeKey(node) {
      return getNodeKey(this.nodeKey, node.data);
    },

    handleNodeExpand(nodeData, node, instance) {
      this.broadcast('ShopeeTreeNode', 'tree-node-expand', node);
      this.$emit('node-expand', nodeData, node, instance);
    },

  }
};
</script>
