import Vue from 'vue';
import ShopeeSearch from '../index';
import { destroyInstance, createElement, triggerSVGClick, dispatchKeyboardEvent } from '@/test/utils';

Vue.use(ShopeeSearch);

const createSimpleSelect = (options = {}) => {
  const { disabled, clearable } = options;
  return new Vue({
    template: `<shopee-search ref="search" v-model="value" :disabled="disabled" :clearable="clearable">
        <shopee-option v-for="(option, index) in options" :key="index" :value="option.value">{{option.label}}</shopee-option>
      </shopee-search>`,
    data() {
      return {
        value: -1,
        disabled,
        clearable,
        options: [{
          value: 1,
          label: 'option1'
        }, {
          value: 2,
          label: 'option2'
        }, {
          value: 3,
          label: 'option3'
        }]
      };
    }
  }).$mount(createElement());
};

describe('search.vue', () => {
  let vm;
  afterEach(() => {
    destroyInstance(vm);
  });
  it('should render correct', () => {
    vm = createSimpleSelect();
    expect(vm.$el.classList.contains('shopee-search')).to.be.true;
  });

  it('should triggle visible when input clicked', done => {
    vm = createSimpleSelect();
    vm.$el.querySelector('.shopee-input').click();
    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      expect(popper.$el.style.display).to.equals('');
      vm.$el.querySelector('.shopee-input').click();
      setTimeout(() => {
        expect(popper.$el.style.display).to.equals('none');
        done();
      }, 500);
    });
  });

  it('should search current value', done => {
    vm = createSimpleSelect();
    vm.$el.querySelector('.shopee-input').click();
    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      popper.$el.querySelector('.shopee-search__menu').querySelector('.shopee-option').click();
      setTimeout(() => {
        expect(vm.$data.value).to.equals(1);
        done();
      });
    });
  });

  it('search disabled', done => {
    vm = createSimpleSelect({disabled: true});
    vm.$el.querySelector('.shopee-input').click();
    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      expect(popper.$el.style.display).to.equals('none');
      done();
    });
  });

  it('option disabled', done => {
    vm = new Vue({
      template: `<shopee-search v-model="value" ref="search">
        <shopee-option v-for="(option, index) in options" :key="index" :value="option.value" disabled>{{option.label}}</shopee-option>
      </shopee-search>`,
      data() {
        return {
          value: -1,
          options: [{
            value: 1,
            label: 'option1'
          }, {
            value: 2,
            label: 'option2'
          }, {
            value: 3,
            label: 'option3'
          }]
        };
      }
    }).$mount(createElement());
    vm.$el.querySelector('.shopee-input').click();
    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      popper.$el.querySelector('.shopee-search__menu').querySelector('.shopee-option').click();
      setTimeout(() => {
        expect(vm.$data.value).to.equals(-1);
        done();
      });
    });
  });

  it('clearable', done => {
    vm = vm = createSimpleSelect();
    vm.$el.querySelector('.shopee-input').click();
    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      popper.$el.querySelector('.shopee-search__menu').querySelector('.shopee-option').click();
      setTimeout(() => {
        triggerSVGClick(vm.$el.querySelector('.shopee-input__clear-btn'));
        setTimeout(() => {
          expect(vm.$data.query).to.be.undefined;
          expect(vm.$data.value).to.equals('');
          done();
        });
      });
    });
  });

  it('enable outer clear', done => {
    let vm = new Vue({
      template: '<shopee-search v-model="value" ref="search" clearable></shopee-search>',
      data() {
        return {
          value: 'test',
        };
      }
    }).$mount(createElement());
    vm.$refs.search.clear();
    setTimeout(() => {
      expect(vm.$data.value).to.equals('');
      done();
    });
  });

  it('keyboard support', done => {
    vm = new Vue({
      template: `<shopee-search v-model="value" ref="search">
        <shopee-option :value="0" disabled>option0</shopee-option>
        <shopee-option v-for="(option, index) in options" :key="index" :value="option.value">{{option.label}}</shopee-option>
      </shopee-search>`,
      data() {
        return {
          value: -1,
          options: [{
            value: 1,
            label: 'option1'
          }, {
            value: 2,
            label: 'option2'
          }, {
            value: 3,
            label: 'option3'
          }]
        };
      }
    }).$mount(createElement());

    let input = vm.$el.querySelector('.shopee-input');
    // arrow down
    dispatchKeyboardEvent(input, 40);

    const popper = vm.$refs.search.$refs.popper;
    setTimeout(() => {
      expect(popper.$el.style.display).to.equals('');
      // arrow down
      dispatchKeyboardEvent(input, 40);
      setTimeout(() => {
        expect(vm.$refs.search.activeIndex).to.equal(1);
        // arrow up
        dispatchKeyboardEvent(input, 38);
        setTimeout(() => {
          expect(vm.$refs.search.activeIndex).to.equal(3);
          // enter
          dispatchKeyboardEvent(input, 13);
          setTimeout(() => {
            expect(vm.value).to.equal(3);
            done();
          });
        });
      });
    });
  });
});
