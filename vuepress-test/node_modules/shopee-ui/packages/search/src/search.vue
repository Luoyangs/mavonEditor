<template>
  <div class="shopee-search" v-shopee-clickoutside="clickOutside">
    <shopee-input
      ref="popperRef"
      :disabled="disabled"
      :value="inputValue"
      :placeholder="placeholder"
      :clearable="clearable"
      :size="size"
      :restriction="restriction"
      :restriction-type="restrictionType"
      @keydown.native.down.stop.prevent="navigation('next')"
      @keydown.native.up.stop.prevent="navigation('prev')"
      @keydown.native.enter.prevent="selectOption"
      @clear="clear()"
      @click="toggleVisible()"
      @input="queryChange($event)">
      <shopee-icon
        slot="suffix"
        class="shopee-input__suffix-icon"
        :class="{ 'disabled': disabled }"
        :svg="suffixIcon"
        @click.native.stop="search"></shopee-icon>
    </shopee-input>
    <shopee-popper
      ref="popper"
      :class="popperClass"
      :visible="visible && searchable"
      :placement="placement"
      :flippable="popperFlippable"
      :append-to-body="appendToBody">
      <div ref="menu"
        class="shopee-search__menu"
        :class="{'no-result': !hasSearchResult}"
        :style="{
          'max-width': maxWidth + 'px',
          'min-width': minWidth,
          'max-height': maxHeight + 'px',
        }">
        <slot></slot>
      </div>
    </shopee-popper>
  </div>
</template>
<script>
import { Input as ShopeeInput } from 'shopee-ui/lib/input';
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';
import { EventBusMixin, PopperMixin } from 'shopee-ui/lib/base';
import { ShopeeClickoutside } from 'shopee-ui/lib/base';
import { RESTRICTION_TYPE } from 'shopee-ui/lib/base';
import SEARCH_ICON from '@shopee-ui/icon/svg/search.svg';

export default {
  name: 'ShopeeSearch',
  directives: {ShopeeClickoutside},
  components: {
    ShopeeInput,
    ShopeeIcon,
    ShopeePopper
  },
  mixins: [EventBusMixin, PopperMixin],
  props: {
    value: {},
    placement: {
      default: 'bottom-start'
    },
    disabled: Boolean,
    clearable: {
      type: Boolean,
      default: true
    },
    searchWhenClear: {
      type: Boolean,
      default: true
    },
    placeholder: String,
    // size of input: large, large, normal, small
    size: String,
    suffixIcon: {
      type: String,
      default: SEARCH_ICON
    },
    maxWidth: Number,
    maxHeight: {
      type: Number,
      default: 204
    },
    // same with shop-input attr
    restriction: [String, Function, RegExp],
    restrictionType: {
      type: String,
      default: RESTRICTION_TYPE.INPUT
    }
  },
  data() {
    return {
      options: [],
      visible: false,
      query: null,
      activeIndex: -1,
      minWidth: '',
      hasSearchResult: true
    };
  },
  computed: {
    inputValue() {
      // 在输入筛选值的时候, 或者手动删除(不是点击clear按钮)时
      if (this.query || this.query === '') {
        return this.query;
      } else {
        const value = this.value;
        let inputValue = '';
        this.options.forEach(option => {
          if (option.acturalValue === value) {
            inputValue = option.acturalLabel;
          }
        });
        return inputValue || value || '';
      }
    },
    searchable() {
      return this.options.length > 0;
    }
  },
  watch: {
    visible(val) {
      if (val) {
        if (!this.minWidth) {
          this.minWidth = this.$refs.popperRef.$el.getBoundingClientRect().width + 'px';
        }
      }
    },
    query(value) {
      this.searchByQuery(value);
    },
    activeIndex(val) {
      this.options.forEach(option => option.active = false);
      if (val !== -1) {
        this.options[val].active = true;
      }
    }
  },
  created() {
    this.$on('option-click', this.setSelectOption);
    this.$on('option-added', option => {
      this.options.push(option);
    });
    this.$on('option-removed', option => {
      let options = this.options;
      for (let i = 0, l = options.length; i < l; i++) {
        if (options[i].acturalValue === option.acturalValue) {
          options.splice(i, 1);
          break;
        }
      }
    });
  },
  methods: {
    navigation(direct) {
      if (direct === 'next') {
        // show options when hidden
        if (!this.visible) {
          this.show();
          return;
        }
      }
      if (!this.visible) {
        return;
      }
      let optionLength = this.options.length;
      let activeIndex = this.activeIndex;
      this.options.forEach(option => option.active = false);
      if (direct === 'next') {
        activeIndex = (++activeIndex + optionLength) % optionLength;
      } else {
        activeIndex = (--activeIndex + optionLength) % optionLength;
      }
      this.activeIndex = activeIndex;
      if (!this.options[activeIndex].visible || this.options[activeIndex].disabled) {
        this.navigation(direct);
      }
    },
    selectOption() {
      if (this.searchable) {
        const selectedOption = this.options[this.activeIndex];
        if (selectedOption) {
          this.setSelectOption(selectedOption);
        }
      } else {
        this.search();
      }
    },
    setSelectOption(item) {
      this.hide();
      const { acturalValue } = item;
      this.query = null;
      // 这里使用$nextTick，是为了防止query值变化导致value的更新混乱
      // 这里其实会让value的值更新两次：第一次，我们其实只想更新query的值，第二次才是为了更新value
      this.$nextTick(() => {
        this.searchBySelect(acturalValue);
        this.$emit('input', acturalValue);
        if (acturalValue !== this.value) {
          this.$emit('search', acturalValue);
          this.dispatch('ShopeeFormItem', 'field-change', acturalValue);
        }
      });
    },
    show() {
      if (this.disabled) {
        return;
      }

      this.visible = true;
      this.$emit('visible-change', true);
    },
    hide() {
      this.visible = false;
      this.$emit('visible-change', false);
    },
    clickOutside() {
      if (this.visible) {
        this.hide();
        this.dispatch('ShopeeFormItem', 'field-blur', this.value);
      }
    },
    toggleVisible() {
      if (!this.searchable) {
        return;
      }

      if (this.visible) {
        this.hide();
      } else {
        this.show();
      }
    },
    queryChange(e) {
      const value = e.target.value;
      if (this.searchable && !this.inputReadonly && value.length > 0) {
        this.show();
        this.$nextTick(() => {
          this.$refs.popper.updatePopper();
        });
      }
      this.updateMenuStyle();
      this.query = value;
    },
    searchByQuery(value) {
      this.$emit('input', value);
      this.broadcast('ShopeeOption', 'query-change', value || '');
      this.activeIndex = -1;
    },
    searchBySelect(value) {
      let inputValue = value;
      this.options.forEach(option => {
        if (option.acturalValue === value) {
          inputValue = option.acturalLabel;
        }
      });
      this.searchByQuery(inputValue);
    },
    clear() {
      if (this.clearable) {
        this.query = null;
        this.$emit('input', undefined);
        // 清空之后，重新选择
        this.searchByQuery('');
        if (this.searchWhenClear) {
          this.$emit('search', undefined);
        }
        this.dispatch('ShopeeFormItem', 'field-change', undefined);
        this.dispatch('ShopeeFormItem', 'field-focus');
      }
    },
    search() {
      if (!this.disabled) {
        this.$emit('search', this.inputValue);
      }
    },
    updateMenuStyle() {
      this.$nextTick(() => {
        const menuDOM = this.$refs.menu;
        let flag = false;
        if (menuDOM) {
          const height = menuDOM.getBoundingClientRect().height;
          flag = height > 20;
        }

        const groups = menuDOM.querySelectorAll('.shopee-option-group__options') || [];
        let hiddenCount = 0;
        groups.forEach(item => {
          item.parentNode.style.display = 'block';
          if (item && item.getBoundingClientRect().height < 8) {
            item.parentNode.style.display = 'none';
            hiddenCount++;
          }
        });
        if (hiddenCount === groups.length) {
          flag = false;
        }

        this.hasSearchResult = flag;
      });
    }
  }
};
</script>
