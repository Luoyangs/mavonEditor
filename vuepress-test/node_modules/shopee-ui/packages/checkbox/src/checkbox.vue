<template>
    <label class="shopee-checkbox"
        :class="[
            type ? 'shopee-checkbox--' + type : '',
            {
                'disabled': isDisabled,
                'indeterminate': indeterminate
            }
        ]">
        <input type="checkbox"
            class="shopee-checkbox__input"
            :name="name"
            :value="currentValue"
            :disabled="isDisabled"
            @change="onChange($event)"
            v-model="model">
        <span class="shopee-checkbox__indicator">
          <shopee-icon :svg="checkedIcon" v-if="!indeterminate"></shopee-icon>
          <shopee-icon :svg="indeterminateIcon" v-if="indeterminate"></shopee-icon>
        </span>
        <span class="shopee-checkbox__label" :style="labelStyle" v-if="$slots.default && $slots.default.length > 0"><slot></slot></span>
    </label>
</template>

<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { EventBusMixin } from 'shopee-ui/lib/base';
import checkedIcon from '@shopee-ui/icon/svg/checkbox-checked.svg';
import indeterminateIcon from '@shopee-ui/icon/svg/checkbox-no-all.svg';

export default {
  name: 'ShopeeCheckbox',
  model: {
    prop: 'acturalValue',
    event: 'input'
  },
  components: {
    ShopeeIcon
  },
  mixins: [EventBusMixin],
  props: {
    // which v-model bind
    acturalValue: {},
    type: String, // outline or default
    name: String,
    value: {},
    indeterminate: Boolean,
    disabled: Boolean
  },
  data() {
    return {
      changeFromGroup: false,
      model: !!this.acturalValue || this.$attrs.checked !== undefined,
      checkedIcon,
      indeterminateIcon
    };
  },
  computed: {
    checkboxGroup() {
      let parent = this.$parent;
      while (parent && parent.$options.name !== 'ShopeeCheckboxGroup') {
        parent = parent.$parent;
      }
      return parent;
    },
    currentValue() {
      return this.value || (this.$slots.default && this.$slots.default[0].text && String(this.$slots.default[0].text).trim());
    },
    isDisabled() {
      return this.checkboxGroup && this.checkboxGroup.disabled || this.disabled;
    },
    labelStyle() {
      const styles = {};
      const fixWidth = this.checkboxGroup && this.checkboxGroup.fixWidth;

      if (fixWidth && typeof fixWidth === 'number') {
        styles.width = `${fixWidth}px`;
        styles.minWidth = `${fixWidth}px`;
        styles.maxWidth = `${fixWidth}px`;
      }

      return styles;
    }
  },
  watch: {
    // watch v-model change
    acturalValue(val) {
      this.model = !!val;
    },
    model(val) {
      if (!this.changeFromGroup) {
        // dispatch change event to checkbox-group
        this.dispatch('ShopeeCheckboxGroup', 'checkbox-change', {
          value: this.currentValue,
          checked: val
        });
      }
      this.changeFromGroup = false;
    }
  },
  created() {
    if (this.checkboxGroup) {
      this.$watch('checkboxGroup.value', value => {
        let newValue = this.model;
        if (value && value.indexOf(this.currentValue) !== -1) {
          newValue = true;
        } else {
          newValue = false;
        }
        if (newValue !== this.model) {
          this.changeFromGroup = true;
          this.model = newValue;
        }
      }, {
        immediate: true
      });
      this.$watch('currentValue', value => {
        if (this.checkboxGroup.value.indexOf(value) !== -1) {
          this.model = true;
        } else {
          this.model = false;
        }
      });
    }
  },
  methods: {
    onChange(e) {
      let checked = e.target.checked;
      this.model = !!checked;
      this.$emit('input', !!checked);
      this.$emit('change', !!checked);
    }
  }
};
</script>
