<template>
    <div :class="[prefixClass, 'shopee-pagination__part']">
      <shopee-button :class="[prefixClass + '__button-prev']"
        size="small"
        :icon="arrowLeftIcon"
        frameless
        full-width
        :disabled="preBtnDisabled"
        @click="prev()"></shopee-button>
      <ul :class="[prefixClass + '__pages']" v-if="type === 'default' || type === 'increase'">
        <li :class="[prefixClass + '__page', page.index === current ? 'active' : '', page.isPage ? '' : prefixClass + '__dot']"
          v-for="(page, index) in pages"
          :key="index"
          @click="jumpTo(page)">{{page.index}}</li>
      </ul>
      <div :class="[prefixClass + '__pages', prefixClass + '__pages--simple']" v-if="type === 'simple'">
        <span :class="[prefixClass + '__current']">{{current}}</span>
        <span :class="[prefixClass + '__split']">/</span>
        <span :class="[prefixClass + '__total']">{{actualPageCount}}</span>
      </div>
      <shopee-button :class="[prefixClass + '__button-next']"
        size="small"
        :icon="arrowRightIcon"
        frameless
        full-width
        :disabled="nextBtnDisabled"
        @click="next()"></shopee-button>
    </div>
</template>
<script>
import { Button as ShopeeButton } from 'shopee-ui/lib/button';
import arrowLeftIcon from '@shopee-ui/icon/svg/arrow-left.svg';
import arrowRightIcon from '@shopee-ui/icon/svg/arrow-right.svg';

const NormalDefaultPagerCount = 7;
const IncreaseDefaultPagerCount = 5;

export default {
  name: 'ShopeePager',
  components: {
    ShopeeButton
  },
  props: {
    type: {
      type: String,
      default: 'default',
      validator(value = 'default') {
        return ['default', 'simple','increase'].indexOf(value) >= 0;
      }
    },
    current: {
      type: Number,
      default: 1
    },
    pageSize: {
      type: Number,
      default: 10
    },
    pagerCount: {
      type: Number,
      default: 0
    },
    total: {
      type: Number,
      default: 0
    },
    pageCount: {
      type: Number,
      default: 0
    },
    hasMore: Boolean
  },
  data() {
    return {
      arrowLeftIcon,
      arrowRightIcon,
      prefixClass: 'shopee-pager'
    };
  },
  computed: {
    pages() {
      let pageCount = this.actualPageCount;
      let pagerCount = this.validPagerCount;
      let pages = [];
      let hasMore = this.hasMore;
      if (this.type !== 'increase') {
        //普通模式的显示槽数（包括...）是固定的
        if (pageCount <= pagerCount) {
          for (let i = 1; i <= pageCount; i++) {
            pages.push({
              isPage: true,
              index: i
            });
          }
          return pages;
        } else {
          pages = new Array(pagerCount);
          pages[0] = {
            index: 1,
            isPage: true
          };
          pages[pagerCount - 1] = {
            index: pageCount,
            isPage: true
          };
          const halfPagerCount = Math.floor((pagerCount + 1) / 2);
          /**
           * if current <= 4
           *   eg. 1, 2, 3, [4], 5, ..., n
           * else if current >= n-3
           *   eg. 1, ..., n-4, [n-3], n-2, n-1, n
           * else
           *   eg. 1, ..., current-1, [current], current+1, ..., n
           */
          /**
           * if current <= halfPagerCount
           *   eg. 1, 2, 3, [4], 5, ..., n
           * else if current >= n - halfPagerCount + 1
           *   eg. 1, ..., n-4, [n-3], n-2, n-1, n
           * else
           *   eg. 1, ..., current-1, [current], current+1, ..., n
           */
          let current = this.current;
          if (current <= halfPagerCount) {
            for (let i = 2; i <= pagerCount - 2; i++) {
              pages[i - 1] = {
                index: i,
                isPage: true
              };
            }
            pages[pagerCount - 2] = {
              index: '...',
              isPage: false
            };
            return pages;
          } else if (current >= pageCount - halfPagerCount + 1) {
            pages[1] = {
              index: '...',
              isPage: false
            };
            for (let i = 0; i <= pagerCount - 3; i++) {
              pages[i + 2] = {
                index: pageCount - (pagerCount - 3) + i,
                isPage: true
              };
            }
            return pages;
          } else {
            pages[1] = pages[pagerCount - 2] = {
              index: '...',
              isPage: false
            };
            const offset = Math.floor(pagerCount / 2) - 2;
            for (let i = current - offset; i <= current + offset;i++) {
              pages[2 + (i - current + offset)] = {
                index: i,
                isPage: true
              };
            }
            return pages;
          }
        }
      } else {
        // add increase type
        if (pageCount < pagerCount || pageCount === pagerCount && !hasMore) {
          for (let i = 1; i <= pageCount; i++) {
            pages.push({
              isPage: true,
              index: i
            });
          }
          return pages;
        } else {
          const halfPagerCount = Math.floor((pagerCount + 1) / 2);
          /**
           * if current <= 3
           *   eg. 1, 2, [3], 4, ...
           * else if current >= n-2 && hasMore === false
           *   eg. 1, ..., n-3, [n-2], n-1, n
           * else
           *   eg. 1, ..., current-1, [current], current+1, ...
           */
          let current = this.current;
          if (current <= halfPagerCount) {
            pages = new Array(pagerCount);
            for (let i = 1; i <= pagerCount - 1; i++) {
              pages[i - 1] = {
                index: i,
                isPage: true
              };
            }
            pages[pagerCount - 1] = {
              index: '...',
              isPage: false
            };
            return pages;
          } else if (current >= pageCount - halfPagerCount + 1 && !hasMore) {
            pages = new Array(pagerCount + 1);
            pages[0] = {
              index: 1,
              isPage: true
            };
            pages[1] = {
              index: '...',
              isPage: false
            };
            for (let i = 2; i <= pagerCount; i++) {
              pages[i] = {
                index: pageCount - pagerCount + i,
                isPage: true
              };
            }
            return pages;
          } else {
            pages = new Array(pagerCount + 1);
            pages[0] = {
              index: 1,
              isPage: true
            };
            pages[1] = pages[pagerCount] = {
              index: '...',
              isPage: false
            };
            const offset = Math.floor(pagerCount / 2) - 1;
            for (let i = current - offset; i <= current + offset;i++) {
              pages[2 + (i - current + offset)] = {
                index: i,
                isPage: true
              };
            }
            return pages;
          }
        }
      }
    },
    actualPageCount() {
      return this.pageCount || Math.ceil(this.total / this.pageSize);
    },
    preBtnDisabled() {
      if (this.current <= 1) {
        return true;
      }
      return false;
    },
    nextBtnDisabled() {
      if (this.type === 'increase') {
        return this.current >= this.actualPageCount && !this.hasMore;
      } else {
        if (this.current >= this.actualPageCount) {
          return true;
        }
        return false;
      }
    },
    validPagerCount() {
      // increase默认为5，其他默认为7
      if (!this.checkPagerCountValid(this.pagerCount)) {
        if (this.type === 'increase') {
          return IncreaseDefaultPagerCount;
        } else {
          return NormalDefaultPagerCount;
        }
      }
      return this.pagerCount;
    }
  },
  methods: {
    checkPagerCountValid(pagerCount) {
      //pagerCount 是范围为 [5 - 21](increase)  [7 - 21] 非increase 之间的奇数
      pagerCount = Number(pagerCount);
      if (!pagerCount ||
          (this.type === 'increase' && pagerCount < IncreaseDefaultPagerCount) ||
          (this.type !== 'increase' && pagerCount < NormalDefaultPagerCount) ||
          pagerCount > 21 ||
          (pagerCount % 2) !== 1) {
        return false;
      }
      return true;
    },

    jumpTo(page) {
      if (typeof page === 'object') {
        if (page.isPage) {
          page = page.index;
        } else {
          return;
        }
      }
      if (page !== this.current) {
        this.$emit('change', page);
      }
    },
    prev() {
      this.jumpTo(this.current - 1);
    },
    next() {
      this.jumpTo(this.current + 1);
    }
  }
};
</script>
