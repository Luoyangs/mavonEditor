<template>
  <span :class="avatarClass" :style="sizeStyle">
    <!-- support img -->
    <div :class="`${prefixClass}-img`" v-if="isImageExist && src" :style="imgStyle"></div>
    <!-- support icon -->
    <shopee-icon v-else-if="icon" :svg="icon"></shopee-icon>
    <!-- support self design -->
    <slot v-else-if="$slots.default"></slot>
    <!-- display default icon -->
    <shopee-icon v-else :svg="defaultIcon"></shopee-icon>
  </span>
</template>
<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import productIcon from '@/static/svg/product-img.svg';
import userIcon from '@/static/svg/user-img.svg';

export default {
  name: 'ShopeeAvatar',
  components: {
    ShopeeIcon
  },
  props: {
    size: {
      type: [Number, String],
      default: 'normal',
      validator(val) {
        if (typeof val === 'string') {
          return ['large', 'normal', 'small', 'x-small'].indexOf(val) > -1;
        }
        return typeof val === 'number';
      }
    },
    circle: Boolean,
    icon: String,
    src: String,
    error: Function
  },
  data() {
    return {
      prefixClass: 'shopee-avatar',
      isImageExist: true
    };
  },
  computed: {
    avatarClass() {
      const { size, icon, circle, prefixClass } = this;

      return {
        [prefixClass]: true,
        [`${prefixClass}--${size}`]: size && typeof size === 'string',
        [`${prefixClass}--circle`]: circle,
        [`${prefixClass}--icon`]: icon
      };
    },
    sizeStyle() {
      const size = this.size;
      return typeof size === 'number' ? {
        height: `${size}px`,
        width: `${size}px`,
        lineHeight: `${size}px`
      } : {};
    },
    imgStyle() {
      let styles = {};

      if (this.src && this.isImageExist) {
        styles = {
          'background-image': `url(${this.src})`,
          'background-size': 'cover',
          'background-repeat': 'no-repeat',
          'background-position': 'center center'
        };
      }
      return styles;
    },
    defaultIcon() {
      if (this.circle) {
        return userIcon;
      }

      return productIcon;
    }
  },
  watch: {
    'src': {
      immediate: true,
      handler(val) {
        if (val) {
          const img = new Image();
          img.onerror = this.handleError;
          img.src = val;
        }
      }
    }
  },
  methods: {
    handleError() {
      const { error } = this;
      const errorFlag = error ? error() : undefined;
      if (errorFlag !== false) {
        this.isImageExist = false;
      }
    }
  }
};
</script>
