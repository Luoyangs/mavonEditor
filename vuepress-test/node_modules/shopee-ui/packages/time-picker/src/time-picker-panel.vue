<template>
  <div class="shopee-time-picker-panel">
    <div class="shopee-time-picker-panel__body">
      <div class="shopee-time-picker-panel__display-box">
        <span v-if="!hideMinute">:</span>
        <span v-if="!hideSecond">:</span>
      </div>
      <shopee-time-spinner
        class="shopee-time-picker__hour-spinner"
        ref="hourSpinner"
        :value="hour"
        :max="24"
        :disabled-values="computedDisabledHours"
        :show-disabled="showDisabledTime"
        @input="onInput('hour', $event)"
      ></shopee-time-spinner>
      <shopee-time-spinner
        v-if="!hideMinute"
        class="shopee-time-picker__minute-spinner"
        ref="minuteSpinner"
        :value="minute"
        :max="60"
        :disabled-values="computedDisabledMinutes"
        :show-disabled="showDisabledTime"
        @input="onInput('minute', $event)"
      ></shopee-time-spinner>
      <shopee-time-spinner
        v-if="!hideSecond"
        class="shopee-time-picker__second-spinner"
        ref="secondSpinner"
        :value="second"
        :max="60"
        :disabled-values="computedDisabledSeconds"
        :show-disabled="showDisabledTime"
        @input="onInput('second', $event)"
      ></shopee-time-spinner>
    </div>
    <div class="shopee-time-picker-panel__footer" v-if="showConfirm">
      <shopee-button size="small" type="primary" :disabled="disabledConfirm" @click="onConfirm">{{t('shopee-ui.time-picker.confirm')}}</shopee-button>
    </div>
  </div>
</template>

<script>
import { Button as ShopeeButton } from 'shopee-ui/lib/button';
import ShopeeTimeSpinner from './time-spinner.vue';
import { LocaleMixin } from 'shopee-ui/lib/base';
import { isArray, isValidDate } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeeTimePickerPanel',
  components: {
    ShopeeButton,
    ShopeeTimeSpinner
  },
  mixins: [LocaleMixin],
  props: {
    value: {},
    format: {
      type: String,
      default: 'HH:mm:ss',
      validator(val) {
        return ['HH:mm:ss', 'HH:mm', 'HH'].indexOf(val) > -1;
      }
    },
    disabledHours: [Array, Function],
    disabledMinutes: [Array, Function],
    disabledSeconds: [Array, Function],
    showDisabledTime: Boolean,
    showConfirm: Boolean
  },
  data() {
    return {
      hour: 0,
      minute: 0,
      second: 0,
      hideMinute: true,
      hideSecond: true,
      cacheValue: new Date(),
    };
  },
  computed: {
    computedDisabledHours() {
      let disabledHours = this.disabledHours;
      if (typeof disabledHours === 'function') {
        disabledHours = disabledHours();
      }
      return isArray(disabledHours) ? disabledHours.map(n => Number(n)) : [];
    },
    computedDisabledMinutes() {
      let disabledMinutes = this.disabledMinutes;
      if (typeof disabledMinutes === 'function') {
        disabledMinutes = disabledMinutes(this.hour);
      }
      return isArray(disabledMinutes) ? disabledMinutes.map(n => Number(n)) : [];
    },
    computedDisabledSeconds() {
      let disabledSeconds = this.disabledSeconds;
      if (typeof disabledSeconds === 'function') {
        disabledSeconds = disabledSeconds(this.hour, this.minute);
      }
      return isArray(disabledSeconds) ? disabledSeconds.map(n => Number(n)) : [];
    },
    disabledConfirm() {
      return this.computedDisabledHours.indexOf(this.hour) > -1 ||
        (!this.hideMinute && this.computedDisabledMinutes.indexOf(this.minute) > -1) ||
        (!this.hideSecond && this.computedDisabledSeconds.indexOf(this.second) > -1);
    }
  },
  mounted() {
    this.resetView();
  },
  methods: {
    resetView() {
      this.checkFormat();
      let value = this.value;
      if (!this.value) {
        value = this.cacheValue;
      }
      // update time value
      if (isValidDate(value)) {
        this.hour = value.getHours();
        this.minute = value.getMinutes();
        this.second = value.getSeconds();
      }
      if (this.$refs.hourSpinner) {
        this.$refs.hourSpinner.presetValue(this.hour);
      }
      if (this.$refs.minuteSpinner) {
        this.$refs.minuteSpinner.presetValue(this.minute);
      }
      if (this.$refs.secondSpinner) {
        this.$refs.secondSpinner.presetValue(this.second);
      }
    },
    checkFormat() {
      const [hourTag, minuteTag, secondTag] = this.format.split(':');
      if (hourTag === 'HH') {
        if (minuteTag === undefined && secondTag === undefined) {
          this.hideMinute = true;
          this.hideSecond = true;
        } else if (minuteTag === 'mm' && secondTag === undefined) {
          this.hideMinute = false;
          this.hideSecond = true;
        } else {
          this.hideMinute = false;
          this.hideSecond = false;
        }
      }
    },
    onInput(type, value) {
      this[type] = value;
      this.setCacheValue();
      if (!this.showConfirm) {
        this.emit();
      }
    },
    onConfirm() {
      if (!this.disabledConfirm) {
        this.emit();
        this.$emit('confirm');
      }
    },
    setCacheValue() {
      const value = this.cacheValue;
      value.setHours(this.hour);
      value.setMinutes(this.minute);
      value.setSeconds(this.second);
      this.cacheValue = value;
    },
    emit() {
      if (!this.disabledConfirm) {
        const value = this.value || new Date();
        const newValue = new Date(value.getTime());
        newValue.setHours(this.hour);
        newValue.setMinutes(this.minute);
        newValue.setSeconds(this.second);
        this.$emit('input', newValue);
        if (newValue.getTime() !== value.getTime()) {
          this.$emit('change', newValue);
        }
      }
    }
  }
};
</script>
