<template>
  <div class="shopee-time-picker" v-shopee-clickoutside="hidePicker">
    <div class="shopee-time-picker__input" ref="popperRef">
      <shopee-selector
        ref="input"
        :size="size"
        :value="displayValue"
        :disabled="disabled"
        :clearable="clearable"
        :placeholder="placeholder"
        :prefix-icon="timeIcon"
        @clear="clear()"
        @click="toggleVisible()"></shopee-selector>
    </div>
    <shopee-popper
      ref="popper"
      class="shopee-time-picker__picker"
      :class="popperClass"
      :visible="visible"
      :placement="placement"
      :flippable="popperFlippable"
      :append-to-body="appendToBody">
      <shopee-time-picker-panel
        ref="picker"
        :value="value"
        :format="format"
        :disabled-hours="disabledHours"
        :disabled-minutes="disabledMinutes"
        :disabled-seconds="disabledSeconds"
        :show-disabled-time="showDisabledTime"
        :show-confirm="showConfirm"
        @change="onPickerChange"
        @confirm="onPickerConfirm"
      ></shopee-time-picker-panel>
    </shopee-popper>
  </div>
</template>
<script>
import fecha from 'fecha';
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';
import { Selector as ShopeeSelector } from 'shopee-ui/lib/selector';
import ShopeeTimePickerPanel from './time-picker-panel.vue';
import { ShopeeClickoutside } from 'shopee-ui/lib/base';
import { EventBusMixin, PopperMixin } from 'shopee-ui/lib/base';
import { isValidDate } from 'shopee-ui/lib/base';
import timeIcon from '@shopee-ui/icon/svg/time.svg';

export default {
  name: 'ShopeeTimePicker',
  directives: {ShopeeClickoutside},
  components: {
    ShopeePopper,
    ShopeeSelector,
    ShopeeTimePickerPanel
  },
  mixins: [EventBusMixin, PopperMixin],
  props: {
    value: {},
    // `time`
    // type: {
    //   type: String,
    //   default: 'time'
    // },
    format: {
      type: String,
      default: 'HH:mm:ss'
    },
    // size of input: x-large, large, normal, small
    size: String,
    disabled: Boolean,
    clearable: {
      type: Boolean,
      default: true
    },
    placeholder: String,
    disabledHours: [Array, Function],
    disabledMinutes: [Array, Function],
    disabledSeconds: [Array, Function],
    showDisabledTime: Boolean,
    placement: {
      default: 'bottom-start'
    },
    showConfirm: {
      type: Boolean,
      default: true,
    }
  },
  data() {
    return {
      timeIcon,
      visible: false,
    };
  },
  computed: {
    displayValue() {
      if (!this.value) {
        return '';
      }
      if (isValidDate(this.value)) {
        return fecha.format(this.value, this.format);
      }
    }
  },
  methods: {
    clear() {
      this.emit('');
      this.hidePicker();
    },
    onPickerChange(value) {
      this.emit(value);
    },
    onPickerConfirm() {
      this.hidePicker();
    },
    showPicker() {
      this.visible = true;
      this.$nextTick(() => {
        if (this.$refs.picker) {
          this.$refs.picker.resetView();
        }
      });
    },
    hidePicker() {
      if (this.visible) {
        this.visible = false;
        this.dispatch('ShopeeFormItem', 'field-blur', this.value);
      }
    },
    toggleVisible() {
      if (this.disabled) {
        return;
      }
      if (this.visible) {
        this.hidePicker();
      } else {
        this.showPicker();
      }
    },
    emit(value) {
      this.$emit('input', value);
      if (value !== this.value) {
        this.$emit('change', value);
        this.dispatch('ShopeeFormItem', 'field-change', value);
      }
    }
  }
};
</script>
