<template>
  <li class="shopee-timeline-item" :class="{'shopee-timeline-item--error': error}">
    <div class="shopee-timeline-item__line" :class="{'icon': icon}"></div>
    <div class="shopee-timeline-item__dot" :class="{'icon': icon}">
      <shopee-icon :svg="icon" v-if="icon && !$slots.dot"></shopee-icon>
      <slot v-else name="dot"></slot>
    </div>
    <div class="shopee-timeline-item__main" :style="{maxWidth: maxWidth + 'px'}">
      <p class="shopee-timeline-item__title" @mouseover="hover=true" @mouseleave="hover=false">
        <shopee-tooltip :content="titleTip" :value="titleOverflow && hover" :max-width="maxWidth">
          <!-- getClientRects 只能用于行内元素,返回每一行的信息，返回信息和getBoundingClientRect返回类似 -->
          <span ref="title">
            <template v-if="title && !$slots.title">
              {{ title }}
            </template>
            <slot v-else name="title"></slot>
          </span>
        </shopee-tooltip>
      </p>
      <p class="shopee-timeline-item__content" v-if="$slots.default && !isEmptyElement($slots.default[0])" ref="content" :style="contentStyle">
        <slot></slot>
      </p>
      <span class="shopee-timeline-item__more" v-if="showMore" @click="more = !more">{{ moreText }}</span>
      <span class="shopee-timeline-item__image" v-if="image">
        <img width="56" height="56" :src="image" :alt="imageAlt">
      </span>
      <p class="shopee-timeline-item__time" v-if="time">{{ time }}</p>
    </div>
  </li>
</template>

<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { Tooltip as ShopeeTooltip } from 'shopee-ui/lib/tooltip';
import { LocaleMixin } from 'shopee-ui/lib/base';
const MAX_TITLE_LINES = 2;  // 内容最大行数
const MAX_CONTENT_LINES = 7;  // 内容最大行数, 5+2规则

const getStyle = (ele, prop) => getComputedStyle(ele).getPropertyValue(prop);

export default {
  name: 'ShopeeTimelineItem',
  components: {
    ShopeeIcon,
    ShopeeTooltip
  },
  mixins: [LocaleMixin],
  props: {
    title: String,
    time: {
      type: String,
      required: true
    },
    image: String,
    imageAlt: String,
    icon: String,
    error: Boolean,
    maxWidth: {
      type: Number,
      default: 220
    }
  },
  data() {
    return {
      titleOverflow: false,
      hover: false,
      more: true,
      showMore: false,
      lines: 0
    };
  },
  computed: {
    titleTip() {
      if (this.$slots.title) {
        return this.getSlotText(this.$slots.title[0]) ;
      }

      return this.title;
    },
    moreText() {
      return this.more ? this.t('shopee-ui.timeline.view_all') : this.t('shopee-ui.timeline.collapse');
    },
    contentStyle() {
      const styles = {};

      if (this.more) {
        styles.overflow = 'hidden';
        styles.textOverflow = 'ellipsis';
        styles.webkitBoxOrient = 'vertical';
        styles.display = '-webkit-box';
        styles.webkitLineClamp = this.lines > MAX_CONTENT_LINES ? MAX_CONTENT_LINES - 2 : MAX_CONTENT_LINES;
      }

      return styles;
    }
  },
  mounted() {
    this.isTitleOverflow();
    this.isContentOverflow();
  },
  methods: {
    isEmptyElement(c) {
      return !(c.tag || (c.text && c.text.trim() !== ''));
    },
    getSlotText(slot) {
      let text = slot.text;
      const children = slot.children;

      if (children) {
        text = this.getSlotText(children[0]);
      }

      return text;
    },
    isTitleOverflow() {
      const titleEl = this.$refs.title;
      let flag = false;
      if (titleEl) {
        const rectList = titleEl.getClientRects();
        if (rectList.length > MAX_TITLE_LINES) {
          flag = true;
        }
      }

      this.titleOverflow = flag;
    },
    isContentOverflow() {
      const contentEl = this.$refs.content;
      if (contentEl) {
        const lineHeight = parseFloat(getStyle(contentEl, 'line-height'));
        const height = contentEl.scrollHeight;
        this.lines = Math.ceil(height / lineHeight);

        if (lineHeight * 7 < height) {
          this.showMore = true;
        }
      }
    }
  }
};
</script>
