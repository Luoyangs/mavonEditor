<template>
  <div :class="[prefixClass, prefixClass + '--'+ theme]">
    <span :class="prefixClass + '-item'" v-for="(value, index) in valueArray" :key="index">
      <shopee-input
        ref="otpInput"
        size="large"
        type="primary"
        :value="value"
        placeholder=" "
        restriction="number"
        :disabled="disabled"
        @input="onInput($event, index)"
        @keydown.delete="onDelete($event, index)"
        @keydown.enter="onEnter"
        @keydown.left.prevent="onMove('left', index)"
        @keydown.right.prevent="onMove('right', index)"
        @paste.prevent="onPaste($event, index)"
        @focus="onFocus"
      ></shopee-input>
    </span>
  </div>
</template>

<script>
import { Input as ShopeeInput } from 'shopee-ui/lib/input';

export default {
  name: 'ShopeeOtpInput',
  components: {
    ShopeeInput
  },
  props: {
    length: {
      type: Number,
      default: 6
    },
    disabled: Boolean,
    // box, underline
    theme: {
      type: String,
      default: 'underline'
    }
  },
  data() {
    return {
      prefixClass: 'shopee-otp-input',
      valueArray: new Array(this.length),
      completed: false
    };
  },
  computed: {
    password() {
      return this.valueArray.join('');
    }
  },
  watch: {
    password(value) {
      this.$emit('change', value);
      if (value.length === this.length) {
        this.completed = true;
        this.$emit('completed', true, value);
      } else if (this.completed) {
        this.completed = false;
        this.$emit('completed', false);
      }
    }
  },
  methods: {
    reset() {
      this.valueArray = new Array(this.length);
      this.$refs.otpInput[0].$refs.input.focus();
    },
    onInput(event, index) {
      // avoid repeatedly triggering value-change event when using Microsoft-pingyin
      this.$nextTick(() => {
        this.inputHandle(event.data, index);
      });
    },
    onPaste(event, index) {
      const pasteText = event.clipboardData.getData('text/plain');
      // matching the numbers in pasteText
      const numbers = pasteText.match(/\d/g);
      if (numbers) {
        numbers.forEach(number => {
          this.inputHandle(number, index++);
        });
      }
    },
    inputHandle(value, index) {
      if (value !== '' && !(/^\d$/.test(value))) {
        return;
      }
      if (index < this.length && index >= 0) {
        this.valueArray.splice(index, 1, value);
        // set currentValue same with input value, avoid inputing bug like '22'
        this.$nextTick(() => {
          this.$refs.otpInput[index].currentValue = value;
        });
        // when the value is not empty, mean a effective input.
        // move to the next input box
        if (value) {
          this.moveHandle(index, true);
        }
      }
    },
    onDelete(event, index) {
      const value = event.target.value;
      if (!value) {
        // move to the previous input box
        this.moveHandle(index--, false);
      }
      // set value to empty of index
      this.inputHandle('', index);
    },
    onEnter() {
      if (this.completed) {
        this.$emit('enter', this.password);
      }
    },
    onMove(direction, index) {
      this.moveHandle(index, direction === 'right');
    },
    moveHandle(index, direction) {
      if (direction) {
        // true: move to right
        if (index < this.length - 1) {
          this.$refs.otpInput[index + 1].$refs.input.focus();
        }
      } else {
        // false: move to left
        if (index > 0) {
          this.$refs.otpInput[index - 1].$refs.input.focus();
        }
      }
    },
    onFocus(event) {
      if (event.target.value) {
        event.target.select();
      }
    }
  }
};
</script>
