import Vue from 'vue';
import ShopeeToast from '../index';
import { createInstance, destroyInstance, createElement } from '@/test/utils';

Vue.use(ShopeeToast);

describe('toast.vue', () => {
  let vm;
  afterEach(() => {
    destroyInstance(vm);
    const el = document && document.querySelector('.shopee-toast');
    if (el && el.parentNode) {
      el.parentNode.removeChild(el);
    }
  });

  it('should render correct', () => {
    vm = createInstance(ShopeeToast, {message: 'I am a toast'});
    expect(vm.$el.classList.contains('shopee-toast')).to.be.true;
  });

  it('should render correct type', () => {
    vm = createInstance(ShopeeToast, {message: 'I am a toast', type: 'success'});
    expect(vm.$el.querySelector('.shopee-toast__icon').classList.contains('shopee-toast__icon--success')).to.be.true;
  });

  it('should attach to vue instance', done => {
    vm = new Vue({
      template: '<button @click="toast()">Toast</button>',
      methods: {
        toast() {
          this.$toast.message('test');
        }
      }
    }).$mount(createElement());
    vm.$el.click();
    setTimeout(() => {
      should.exist(document.querySelector('.shopee-toast'));
      done();
    });
  });

  it('should close after 1500', done => {
    vm = new Vue({
      template: '<button @click="toast()">Toast</button>',
      methods: {
        toast() {
          this.$toast.success({
            message: 'test',
            duration: 1500
          });
        }
      }
    }).$mount(createElement());
    vm.$el.click();
    setTimeout(() => {
      const toast = document.querySelector('.shopee-toast');
      should.exist(toast);
      setTimeout(() => {
        expect(toast.style.display).to.equals('none');
        done();
      }, 1750);
    });
  });

  it('should not close when hover', done => {
    vm = new Vue({
      template: '<button @click="toast()">Toast</button>',
      methods: {
        toast() {
          this.$toast.success({
            message: 'test',
            duration: 500,
            keepOnHover: true
          });
        }
      }
    }).$mount(createElement());
    vm.$el.click();
    setTimeout(() => {
      const toast = document.querySelector('.shopee-toast');
      should.exist(toast);
      toast.dispatchEvent(new Event('mouseenter'));
      setTimeout(() => {
        expect(toast.style.display).to.equals('');
        toast.dispatchEvent(new Event('mouseleave'));
        setTimeout(() => {
          expect(toast.style.display).to.equals('none');
          done();
        }, 750);
      }, 1000);
    });
  });

  it('should render correct toasts', done => {
    vm = new Vue({
      template: '<button @click="toast()">Toast</button>',
      methods: {
        toast() {
          this.$toast.message('test');
        }
      }
    }).$mount(createElement());
    vm.$el.click();
    setTimeout(() => {
      const toasts = document.querySelector('.shopee-toasts');
      should.exist(toasts);
      expect(toasts.querySelectorAll('.shopee-toast').length).to.equals(1);
      vm.$el.click();
      setTimeout(() => {
        expect(toasts.querySelectorAll('.shopee-toast').length).to.equals(2);
        done();
      });
    });
  });
});
