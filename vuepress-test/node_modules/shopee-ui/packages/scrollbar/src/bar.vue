<template>
  <div class="shopee-scrollbar__bar"
    :class="[
      vertical ? 'vertical' : 'horizontal'
    ]"
    @mouseover="onMouseover"
    @mouseleave="onMouseleave">
    <div class=""
      :class="[
        'shopee-scrollbar__thumb',
        visible && 'visible'
      ]"
      @mousedown="onThumbClick($event)"
      :style="thumbStyle"></div>
  </div>
</template>

<script>
import { EventBusMixin } from 'shopee-ui/lib/base';
import { debounce } from 'shopee-ui/lib/base';

export default {
  mixins: [EventBusMixin],
  props: {
    manual: Boolean,
    vertical: Boolean,
    offset: Number,
    size: Number
  },
  data() {
    return {
      isThumbDrag: false,
      clickOffset: 0,
      visible: false
    };
  },
  computed: {
    wrapper() {
      return this.$parent.wrapper;
    },
    thumbStyle() {
      return this.vertical ?
        {
          top: this.offset + 'px',
          height: this.size + 'px'
        } : {
          left: this.offset + 'px',
          width: this.size + 'px'
        };
    },
    debounce() {
      return debounce(n => n(), 500);
    }
  },
  watch: {
    offset() {
      this.visible = true;
      if (!this.manual) {
        this.hide();
      }
      // emit scroll event
      // const type = this.vertical ? 'vertical' : 'horizontal';
      // const max = Math.max(this.$el.clientWidth, this.$el.clientHeight);
      // if (val === 0) {
      //   this.dispatch('ShopeeScrollbar', 'scroll-top', type);
      // } else if (val + this.size === max) {
      //   this.dispatch('ShopeeScrollbar', 'scroll-bottom', type);
      // }
    },
  },
  methods: {
    show() {
      this.visible = true;
      this.debounce(() => {
        this.visible = true;
      });
    },
    hide() {
      this.debounce(() => {
        this.visible = false;
      });
    },
    onMouseover() {
      if (!this.manual) {
        this.show();
      }
    },
    onMouseleave() {
      if (!this.manual) {
        this.hide();
      }
    },
    onThumbMove(e) {
      if (!this.isThumbDrag) {
        return;
      }
      const clickOffset = this.clickOffset;
      if (this.vertical) {
        const offset = e.clientY - this.$el.getBoundingClientRect().top;
        this.wrapper.scrollTop = (offset - clickOffset) * this.wrapper.scrollHeight / this.wrapper.clientHeight;
      } else {
        const offset = e.clientX - this.$el.getBoundingClientRect().left;
        this.wrapper.scrollLeft = (offset - clickOffset) * this.wrapper.scrollWidth / this.wrapper.clientWidth;
      }
    },
    onThumbMouseUp() {
      this.isThumbDrag = false;
      this.clickOffset = 0;
      document.removeEventListener('mousemove', this.onThumbMove);
      document.removeEventListener('mouseup', this.onThumbMouseUp);
      document.onselectstart = null;
    },
    onThumbClick(e) {
      e.stopImmediatePropagation();
      this.isThumbDrag = true;
      document.addEventListener('mousemove', this.onThumbMove);
      document.addEventListener('mouseup', this.onThumbMouseUp);
      document.onselectstart = () => false;
      if (this.vertical) {
        this.clickOffset = e.clientY - this.$el.getBoundingClientRect().top - e.target.offsetTop;
      } else {
        this.clickOffset = e.clientX - this.$el.getBoundingClientRect().left - e.target.offsetLeft;
      }
    }
  }
};
</script>

