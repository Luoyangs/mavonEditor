<template>
  <shopee-input :class="className"
    ref="input"
    :value="formatterValue"
    :size="size"
    :disabled="disabled"
    :placeholder="computedPlaceholder"
    :lazy="lazy"
    :error="error"
    :error-message="errorMessage"
    :prefix-label="prefixLabel"
    :prefix-icon="prefixIcon"
    :restriction="restriction"
    restriction-type="value"
    @focus="handleFocus"
    @blur="handleBlur"
    @value-change="handleInput"
    @keydown.up.native.prevent="numberUp()"
    @keydown.down.native.prevent="numberDown()"
    @keydown.enter="handleEnter">
    <template slot="suffix">
      <div :class="[prefixClass + '__controls']">
        <div :class="[prefixClass + '__control up', isControlsUpDisabled ? 'disabled' : '']" @click.stop="handleClickUp">
          <shopee-icon :svg="arrowUpIcon"></shopee-icon>
        </div>
        <div :class="[prefixClass + '__control down', isControlsDownDisabled ? 'disabled' : '']" @click.stop="handleClickDown">
          <shopee-icon :svg="arrowDownIcon"></shopee-icon>
        </div>
      </div><!--
   --><span class="shopee-number-input__suffix" v-if="suffixLabel"><span class="shopee-number-input__suffix-split"></span>{{suffixLabel}}</span>
    </template>
  </shopee-input>
</template>
<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { Input as ShopeeInput } from 'shopee-ui/lib/input';
import { EventBusMixin, FormItemMixin } from 'shopee-ui/lib/base';
import { addDecimalNumber } from 'shopee-ui/lib/base';
import arrowUpIcon from '@shopee-ui/icon/svg/arrow-up-s.svg';
import arrowDownIcon from '@shopee-ui/icon/svg/arrow-down-s.svg';

export default {
  name: 'ShopeeNumberInput',
  components: {
    ShopeeInput,
    ShopeeIcon
  },
  mixins: [EventBusMixin, FormItemMixin],
  props: {
    value: {
      type: [Number, String],
      required: true
    },
    placeholder: String,
    // size of input: x-large, large, normal, small
    size: String,
    max: {
      type: Number,
      default: Infinity
    },
    min: {
      type: Number,
      default: -Infinity
    },
    step: {
      type: Number,
      default: 1
    },
    suffixLabel: String,
    prefixLabel: String,
    prefixIcon: String,
    disabled: Boolean,
    error: Boolean,
    errorMessage: String,
    changeOnEnter: Boolean,
    formatter: Function,
    parser: Function,
    precision: {
      type: Number,
      validator(val) {
        return val >= 0 && val === parseInt(val, 10);
      }
    },
    lazy: Boolean
  },
  data() {
    return {
      arrowUpIcon,
      arrowDownIcon,
      prefixClass: 'shopee-number-input',
      currentValue: ''
    };
  },
  computed: {
    isControlsUpDisabled() {
      return addDecimalNumber(this.currentValue, this.step) > this.max;
    },
    isControlsDownDisabled() {
      return addDecimalNumber(this.currentValue, -this.step) < this.min;
    },
    className() {
      return [
        this.prefixClass,
        this.sizeClass ? `${this.prefixClass}--${this.sizeClass}` : '',
        this.disabled ? 'disabled' : '',
        this.error ? 'error' : '',
        !this.suffixLabel ? `${this.prefixClass}--no-suffix` : ''
      ];
    },
    restriction() {
      const negativeExp = this.min < 0 ? '-?' : '';
      const decimalExp = this.precision === 0 ? '' : '\\.{0,1}';
      const regex = new RegExp(`^${negativeExp}(\\d+${decimalExp}\\d*)?$`);
      if (this.parser) {
        return value => regex.test(this.parser(value));
      } else {
        return regex;
      }
    },
    formatterValue() {
      return this.formatter ? this.formatter(this.currentValue) : this.currentValue;
    },
    computedPlaceholder() {
      const { placeholder, precision } = this;
      const base = 0;

      return placeholder || base.toFixed(precision);
    }
  },
  watch: {
    value: {
      handler(value) {
        if (isNaN(value)) {
          return;
        }
        if (this.currentValue === '' || value !== Number(this.currentValue)) {
          this.setCurrentValue(value);
        }
      },
      immediate: true
    }
  },
  mounted() {
    if ((this.formatter && !this.parser) || (this.parser && !this.formatter)) {
      console.warn('[ShopeeUI warn][NumberInput]: formatter should use with parser in number input');
    }
  },
  methods: {
    handleClickUp() {
      if (this.disabled) {
        return;
      }
      this.numberUp(true);
    },
    handleClickDown() {
      if (this.disabled) {
        return;
      }
      this.numberDown(true);
    },
    numberUp(forceValidate) {
      if (this.isControlsUpDisabled) {
        return;
      }
      this.setCurrentValue(addDecimalNumber(this.currentValue, this.step), forceValidate);
    },
    numberDown(forceValidate) {
      if (this.isControlsDownDisabled) {
        return;
      }
      this.setCurrentValue(addDecimalNumber(this.currentValue, -this.step), forceValidate);
    },
    handleInput(value) {
      if (this.parser) {
        value = this.parser(value);
      }
      if (isNaN(value)) {
        return;
      }
      // to make sure trigger change event of input
      this.currentValue = value;
      this.setCurrentValue(value);
    },
    setCurrentValue(value, forceValidate = false) {
      // remove front 0
      value = value.toString().replace(/^(-?)(0*)([1-9][\d|.]*?)/, '$1$3');

      // toFixed value when over precision or not input
      if (this.precision !== undefined && value.length > 0) {
        // over precision regular expression
        const regex = new RegExp(`^\\-?\\d*?\\.\\d{${this.precision + 1},}$`);
        if (!this.inputFocused || regex.test(value)) {
          value = Number(value).toFixed(this.precision);
        }
      }

      if (!this.inputFocused || forceValidate) {
        if (value >= this.max) {
          value = this.max;
        }
        if (value < this.min) {
          value = this.min;
        }
      }

      this.$nextTick(() => {
        this.currentValue = value;
        this.emit(value.length > 0 ? Number(value) : value, forceValidate);
      });
    },
    emit(value, forceValidate) {
      this.$emit('input', value);
      if (value !== this.value) {
        if (!this.changeOnEnter || forceValidate) {
          this.$emit('change', value);
          this.dispatch('ShopeeFormItem', 'field-change', value);
        }
      }
    },
    handleEnter() {
      this.setCurrentValue(this.currentValue, true);
    },
    handleFocus(event) {
      this.inputFocused = true;
      this.$emit('focus', event);
    },
    handleBlur(event) {
      this.inputFocused = false;
      this.setCurrentValue(this.currentValue, true);
      this.$emit('blur', event);
      this.$nextTick(() => {
        this.dispatch('ShopeeFormItem', 'field-blur', this.value);
      });
    },
    focus() {
      this.$refs.input.focus();
    },
    blur() {
      this.$refs.input.blur();
    }
  }
};
</script>
