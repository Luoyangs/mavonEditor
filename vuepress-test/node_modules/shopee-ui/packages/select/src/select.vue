<template>
  <div :class="className" v-shopee-clickoutside="clickOutside">
    <shopee-selector
      ref="popperRef"
      :value="displayValue"
      :clearable="clearable"
      :multiple="multiple"
      :disabled="disabled"
      :placeholder="placeholder"
      :size="size"
      :suffix-icon="suffixIcon"
      :clear-icon="clearIcon"
      :max-line="maxLine"
      @keydown.native.down.stop.prevent="navigation('next')"
      @keydown.native.up.stop.prevent="navigation('prev')"
      @keydown.native.enter.prevent="selectOption"
      @clear="clear()"
      @click="toggleVisible()"
      @remove-tag="removeTag"
      tabindex="0">
      <slot v-if="$slots.input" name="input"></slot>
    </shopee-selector>
    <shopee-popper
      ref="popper"
      :visible="visible"
      :class="popperClass"
      :flippable="popperFlippable"
      :placement="placement"
      :append-to-body="appendToBody">
      <shopee-input
        :class="prefixClass + '__filter'"
        v-if="filterable"
        ref="filterRef"
        :value="queryValue"
        :placeholder="filterPlaceholder || placeholder"
        :prefix-icon="filterSuffixIcon || defaultFilterSuffixIcon"
        clearable
        @clear="queryClear()"
        @input="queryChange($event)">
      </shopee-input>
      <div :class="prefixClass + '__menu'"
        :style="{
          'max-width': maxWidth + 'px',
          'min-width': minWidth,
          'max-height': maxMenuHeight + 'px',
        }">
        <shopee-scrollbar
          v-show="!emptyText"
          layout="vertical"
          hover-visible
          ref="scroller">
          <div :class="prefixClass + '__options'">
            <slot></slot>
          </div>
        </shopee-scrollbar>
      </div>
      <p :class="prefixClass + '__filter-empty'" v-show="emptyText">
        {{ emptyText }}
      </p>
      <option-add
        v-if="addable"
        :add-item-text="addItemText"
        @add-item="onAddItem">
      </option-add>
    </shopee-popper>
  </div>
</template>
<script>
import { Input as ShopeeInput } from 'shopee-ui/lib/input';
import { Scrollbar as ShopeeScrollbar } from 'shopee-ui/lib/scrollbar';
import { Popper as ShopeePopper } from 'shopee-ui/lib/popper';
import { Selector as ShopeeSelector } from 'shopee-ui/lib/selector';
import { EventBusMixin, PopperMixin, LocaleMixin } from 'shopee-ui/lib/base';
import { ShopeeClickoutside } from 'shopee-ui/lib/base';
import DOWN_ICON from '@shopee-ui/icon/svg/arrow-down.svg';
import SEARCH_ICON from '@shopee-ui/icon/svg/search.svg';
import { isArray, debounce } from 'shopee-ui/lib/base';
import OptionAdd from './option-add.vue';

export default {
  name: 'ShopeeSelect',
  directives: {ShopeeClickoutside},
  components: {
    ShopeeInput,
    ShopeeScrollbar,
    ShopeeSelector,
    ShopeePopper,
    OptionAdd
  },
  mixins: [EventBusMixin, PopperMixin, LocaleMixin],
  props: {
    value: {},
    placement: {
      default: 'bottom-start'
    },
    multiple: { //是否可以多选
      type: Boolean,
      default: false
    },
    multipleLimit: { //最多多选个数
      type: Number,
      default: 0
    },
    addable: Boolean,
    scrollEndAfterAdd: { //新增后是否自动滚动到底部
      type: Boolean,
      default: true
    },
    disabled: Boolean,
    filterable: Boolean,
    noMatchText: String,
    addItemText: String,
    clearable: Boolean,
    placeholder: String,
    // size of input: large, normal, small
    size: String,
    suffixIcon: {
      type: String,
      default: DOWN_ICON
    },
    clearIcon: String,
    maxWidth: {
      type: Number,
      default: 440
    },
    maxLine: Number,
    maxHeight: Number,
    filterMethod: Function,
    filterPlaceholder: String, // only valid when filterable is true
    filterSuffixIcon: String, // only valid when filterable is true
    formatDisplayLabel: Function
  },
  data() {
    return {
      prefixClass: 'shopee-select',
      options: [],
      defaultFilterSuffixIcon: SEARCH_ICON,
      visible: false,
      query: null,
      activeIndex: -1,
      minWidth: '',
    };
  },
  computed: {
    displayValue() {
      let value  = this.value;
      if (this.multiple && !isArray(value)) {
        value = [];
      }
      let displayValue = this.multiple ? [] : '';
      if (this.multiple) {
        if (isArray(value) && value.length) {
          value.forEach(item => {
            let index = this.options.findIndex((option) => option.acturalValue === item);
            if (index >= 0) {
              displayValue.push({
                key: this.options[index].acturalValue,
                label: this.options[index].acturalLabel
              });
            }
          });
        }
      } else {
        if (this.formatDisplayLabel && typeof this.formatDisplayLabel === 'function') {
          return this.formatDisplayLabel(value);
        }
        this.options.forEach(option => {
          if (option.acturalValue === value) {
            displayValue = option.acturalLabel;
          }
        });
      }
      return displayValue;
    },
    queryValue() {
      return this.query || '';
    },

    className() {
      return [
        this.prefixClass,
        this.visible ? 'is-show' : '',
        (this.clearable && (
          (this.multiple && this.displayValue && this.displayValue.length) ||
            (!this.multiple && this.displayValue)
        )
        ) ? 'clearable' : '',
      ];
    },
    debounce() {
      return debounce(n => n(), 50);
    },
    filteredOptionsCount() {
      if (!this.filterable) {
        return 0;
      }
      let count = 0;
      this.options.forEach((option) => {
        if (option.visible) {
          count++;
        }
      });
      return count;
    },
    emptyText() {
      if (!this.filterable || !this.queryValue || this.filteredOptionsCount > 0) {
        return '';
      }
      return this.noMatchText || this.t('shopee-ui.select.no-match-text');
    },
    maxMenuHeight() {
      if (this.maxHeight) {
        return this.maxHeight;
      }
      return this.filterable ? 208 : 218;
    }
  },
  watch: {
    visible(val) {
      if (val) {
        if (!this.minWidth) {
          this.minWidth = this.$refs.popperRef.$el.getBoundingClientRect().width + 'px';
        }
      }
      this.broadcast('ShopeeOptionAdd', 'visible-change', val);
    },
    query(value) {
      this.broadcast('ShopeeOption', 'query-change', value || '');
      this.activeIndex = -1;
    },
    activeIndex(val) {
      this.options.forEach(option => option.active = false);
      if (val !== -1) {
        this.options[val].active = true;
      }
    }
  },
  created() {
    this.$on('option-click', this.setSelectOption);
    this.$on('option-added', option => {
      this.options.push(option);
    });
    this.$on('option-removed', option => {
      let options = this.options;
      for (let i = 0, l = options.length; i < l; i++) {
        if (options[i].acturalValue === option.acturalValue) {
          options.splice(i, 1);
          break;
        }
      }
    });
    if (this.multiple && !isArray(this.value)) {
      this.$emit('input', []);
    }
    if (!this.multiple && isArray(this.value)) {
      this.$emit('input', '');
    }
  },
  methods: {
    navigation(direct) {
      if (direct === 'next') {
        // show options when hidden
        if (!this.visible) {
          this.show();
          return;
        }
      }
      if (!this.visible) {
        return;
      }
      let optionLength = this.options.length;
      let activeIndex = this.activeIndex;
      this.options.forEach(option => option.active = false);
      if (direct === 'next') {
        activeIndex = (++activeIndex + optionLength) % optionLength;
      } else {
        activeIndex = (--activeIndex + optionLength) % optionLength;
      }
      this.activeIndex = activeIndex;
      if (!this.options[activeIndex].visible || this.options[activeIndex].disabled) {
        this.navigation(direct);
      }
    },
    selectOption() {
      let selectedOption = this.options[this.activeIndex];
      this.setSelectOption(selectedOption);
    },
    setSelectOption(item) {
      if (this.multiple) {
        if (!item) {
          return;
        }
        const value = (this.value || []).slice();
        const optionIndex = value.indexOf(item.acturalValue);
        if (optionIndex >= 0) {
          value.splice(optionIndex, 1);
        } else if (this.multipleLimit <= 0 || value.length < this.multipleLimit) {
          value.push(item.acturalValue);
        }
        const changed = !this.arrayEquals(value, this.value);
        this.$emit('input', value);
        if (changed) {
          this.multipleValueChange(value);
        }
      } else {
        this.hide();
        if (!item) {
          return;
        }
        this.$emit('input', item.acturalValue);
        if (item.acturalValue !== this.value) {
          this.$emit('change', item.acturalValue);
          this.dispatch('ShopeeFormItem', 'field-change', item.acturalValue);
        }
      }
    },
    show() {
      if (this.disabled) {
        return;
      }
      this.visible = true;
      this.$emit('visible-change', true);
    },
    hide() {
      this.visible = false;
      this.query = null;
      this.$emit('visible-change', false);
    },
    clickOutside() {
      if (this.visible) {
        this.hide();
        this.dispatch('ShopeeFormItem', 'field-blur', this.value);
      }
    },
    toggleVisible() {
      if (this.visible) {
        this.hide();
      } else {
        this.show();
      }
    },
    queryChange(e) {
      const value = e.target.value;
      this.query = value;
      this.$emit('query-change', this.query);
    },
    queryClear() {
      // this.query = null;
      this.query = '';
      this.$emit('query-change', this.query);
    },

    clear() {
      if (this.clearable) {
        const value = this.multiple ? [] : undefined;
        this.$emit('input', value);
        this.$emit('clear');
        this.dispatch('ShopeeFormItem', 'field-focus');
        this.multipleValueChange(value);
        this.hide();
      }
    },

    removeTag(item) {
      if (!this.disabled && this.multiple && item) {
        const value = (this.value || []).slice();
        const index = value.indexOf(item.key);
        if (index >= 0) {
          value.splice(index, 1);
          this.$emit('input', value);
          this.$emit('remove-tag', item.key);
          this.multipleValueChange(value);
        }
      }
    },

    multipleValueChange(value) {
      this.$emit('change', value);
      this.dispatch('ShopeeFormItem', 'field-change', value);
      this.$nextTick(() => {
        this.$refs.popper.updatePopper();
      });
    },

    arrayEquals(a, b) {
      if (a === b) {
        return true;
      }
      if (!isArray(a)) {
        return false;
      }
      if (!isArray(b)) {
        return false;
      }
      if (a.length !== b.length) {
        return false;
      }
      for (let i = 0; i < a.length; i++) {
        if (a[i] !== b[i]) {
          return false;
        }
      }
      return true;
    },

    onAddItem(val) {
      const oldFilterCount = this.filteredOptionsCount;
      this.$emit('add-item', val);
      if (this.scrollEndAfterAdd) {
        this.$nextTick(() => {
          this.$refs.popper.updatePopper();
          if (this.filterable && this.filteredOptionsCount <= oldFilterCount) {
            return;
          }
          const scroller = this.$refs.scroller;
          if (scroller && scroller.$refs.content) {
            const content = scroller.$refs.content;
            const scrollHeight = content.scrollHeight;
            scroller.scrollTo(scrollHeight, 200);
          }
        });
      }
    }
  }
};
</script>
