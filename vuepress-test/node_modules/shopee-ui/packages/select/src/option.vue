<template>
  <div :class="className" @click.stop="onOptionClick()" v-show="visible">
    <template v-if="label && !$slots.default">
      <span>{{label}}</span>
    </template>
    <slot v-else></slot>
    <shopee-icon :class="[prefixClass + '__selected-icon']" v-if="this.showMultiSelectedIcon" :svg="selectedIcon"></shopee-icon>
  </div>
</template>
<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import SELECTED_ICON from '@shopee-ui/icon/svg/checkbox-checked.svg';
import { EventBusMixin } from 'shopee-ui/lib/base';
import { isArray } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeeOption',
  components: {
    ShopeeIcon
  },
  mixins: [EventBusMixin],
  props: {
    value: {},
    label: String,
    disabled: Boolean
  },
  data() {
    return {
      prefixClass: 'shopee-option',
      visible: true,
      active: false,
      selectedIcon: SELECTED_ICON
    };
  },
  computed: {
    acturalLabel() {
      let slotContent = this.$slots.default && this.$slots.default[0].text && String(this.$slots.default[0].text).trim();
      return this.label || slotContent || this.acturalValue;
    },
    acturalValue() {
      let slotContent = this.$slots.default && this.$slots.default[0].text && String(this.$slots.default[0].text).trim();
      if (typeof this.value === 'undefined') {
        return slotContent;
      }
      return this.value;
    },
    select() {
      let parent = this.$parent;
      while (parent && !['ShopeeSelect', 'ShopeeSearch'].includes(parent.$options.name)) {
        parent = parent.$parent;
      }
      return parent;
    },
    parentName() {
      return this.select && this.select.$options.name || 'ShopeeSelect';
    },
    selected() {
      if (this.select.multiple) {
        return isArray(this.select.value) && this.select.value.includes(this.acturalValue);
      } else {
        return this.acturalValue === this.select.value;
      }
    },
    limitReached() {
      if (this.select.multiple) {
        return !this.selected &&
          (this.select.value || []).length >= this.select.multipleLimit &&
          this.select.multipleLimit > 0;
      } else {
        return false;
      }
    },
    showMultiSelectedIcon() {
      return this.select.multiple && this.selected;
    },
    className() {
      return [
        this.prefixClass,
        this.select.multiple ? 'multiple' : '',
        this.selected ? 'selected' : '',
        this.isDisabled ? 'disabled' : '',
        this.active ? 'active' : ''
      ];
    },
    isDisabled() {
      return this.select.disabled || this.disabled || this.limitReached;
    }
  },
  created() {
    this.dispatch(this.parentName, 'option-added', this);
    this.$on('query-change', query => {
      this.setOptionFilterable(query);
    });
    if (this.select.filterable) {
      this.setOptionFilterable(this.select.queryValue);
    }
  },
  destroyed() {
    this.dispatch(this.parentName, 'option-removed', this);
  },
  methods: {
    onOptionClick() {
      if (this.isDisabled) {
        return;
      }
      this.dispatch(this.parentName, 'option-click', this);
    },
    setOptionFilterable(query) {
      if (this.select.filterMethod) {
        if (this.select.filterMethod(query, this.acturalLabel)) {
          this.visible = true;
        } else {
          this.visible = false;
        }
      } else {
        if (this.acturalLabel.indexOf(query) !== -1) {
          this.visible = true;
        } else {
          this.visible = false;
        }
      }
    }
  }
};
</script>
