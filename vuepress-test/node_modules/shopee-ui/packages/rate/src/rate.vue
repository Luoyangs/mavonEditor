<template>
  <div :class="[
      'shopee-rate',
      disabled && 'shopee-rate-disabled'
    ]"
    @mouseleave="handleMouseleave">
    <div class="shopee-rate-star"
      v-for="(item, index) in count"
      :key="index"
      @mousemove="handleMousemove(item, $event)"
      @click="handleClick">
      <div class="shopee-rate-star__front" :style="starStyles[index]">
        <shopee-icon v-if="icon" :svg="icon"></shopee-icon>
        <template v-else-if="character">{{character}}</template>
        <shopee-icon v-else :svg="starSIcon"></shopee-icon>
      </div>
      <div class="shopee-rate-star__back">
        <shopee-icon v-if="icon" :svg="icon"></shopee-icon>
        <template v-else-if="character">{{character}}</template>
        <shopee-icon v-else :svg="starSIcon"></shopee-icon>
      </div>
    </div>
    <div class="shopee-rate-text" v-if="showText"><slot>{{value}}</slot></div>
  </div>
</template>
<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import { EventBusMixin } from 'shopee-ui/lib/base';
import starSIcon from '@shopee-ui/icon/svg/star.svg';

export default {
  name: 'ShopeeRate',
  components: {
    ShopeeIcon
  },
  mixins: [EventBusMixin],
  props: {
    value: {
      type: Number,
      default: 0
    },
    count: {
      type: Number,
      default: 5
    },
    disabled: Boolean,
    allowHalf: Boolean,
    // effective only when `disabled` is `true`
    allowDecimal: Boolean,
    clearable: Boolean,
    showText: Boolean,
    icon: String,
    character: String
  },
  data() {
    return {
      starSIcon,
      // value for display
      innerValue: 0
    };
  },
  computed: {
    starStyles() {
      const styles = [];
      const value = this.innerValue;
      for (let index = 1; index <= this.count; index++) {
        if (index <= value) {
          styles.push({
            width: '100%'
          });
        } else if (index < value + 1) {
          styles.push({
            width: `${this.getValueSection(value + 1 - index) * 100}%`
          });
        } else {
          styles.push({});
        }
      }
      return styles;
    }
  },
  watch: {
    value: {
      handler(val) {
        this.innerValue = this.formatValue(val);
      },
      immediate: true
    }
  },
  methods: {
    getValueSection(value) {
      if (value <= 0 || value > 1) {
        return 0;
      }
      if (value < 0.4) {
        return 0.25;
      } else if (value < 0.7) {
        return 0.5;
      } else if (value < 1) {
        return 0.75;
      } else {
        return 1;
      }
    },

    formatValue(value) {
      value = value > this.count ? this.count : value < 0 ? 0 : value;
      if (this.disabled && this.allowDecimal) {
        return value;
      } else if (this.allowHalf) {
        return Math.floor(value * 2) / 2;
      } else {
        return Math.floor(value);
      }
    },
    handleMousemove(value, event) {
      if (this.disabled) {
        return;
      }
      // layerX = offsetX + border
      // ie only support offsetX
      const layerX = event.layerX || event.offsetX + 0;
      const width = event.currentTarget.clientWidth;
      if (this.allowHalf && layerX < width / 2) {
        this.innerValue = value - .5;
      } else {
        this.innerValue = value;
      }
    },
    handleClick() {
      if (this.disabled) {
        return;
      }
      const value = this.innerValue;
      this.emit(value);
      this.$nextTick(() => {
        this.innerValue = value;
      });
    },
    handleMouseleave() {
      if (this.disabled) {
        return;
      }
      this.innerValue = this.formatValue(this.value);
    },
    emit(value) {
      if (this.clearable && Math.abs(value - this.value) < 0.01) {
        value = 0;
      }
      this.$emit('input', value);
      if (value !== this.value) {
        this.$emit('change', value);
        this.dispatch('ShopeeFormItem', 'field-change', value);
      }
    }
  }
};
</script>
