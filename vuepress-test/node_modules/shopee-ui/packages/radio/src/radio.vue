<template>
    <label :id="name" class="shopee-radio" :class="{
            'disabled': isDisabled
        }">
        <input type="radio" class="shopee-radio__input"
            :name="name"
            :disabled="isDisabled"
            :value="currentValue"
            @change="onChange"
            v-model="model">
        <span class="shopee-radio__indicator"></span>
        <span class="shopee-radio__label" :style="labelStyle"><slot></slot></span>
    </label>
</template>

<script>
import { EventBusMixin } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeeRadio',
  model: {
    prop: 'acturalValue',
    event: 'input'
  },
  mixins: [EventBusMixin],
  props: {
    // which v-model bind
    acturalValue: {},
    value: {},
    name: {
      type: String
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  data() {
    return {
      changeFromGroup: false,
      model: this.acturalValue
    };
  },
  computed: {
    radioGroup() {
      let parent = this.$parent;
      while (parent && parent.$options.name !== 'ShopeeRadioGroup') {
        parent = parent.$parent;
      }
      return parent;
    },
    currentValue() {
      // the value of radio is the value property if present
      // otherwise return the text of default slot
      const slotContent = this.$slots.default && this.$slots.default[0].text && String(this.$slots.default[0].text).trim();
      if (typeof this.value === 'undefined') {
        return slotContent;
      }
      return this.value;
    },
    isDisabled() {
      return this.radioGroup && this.radioGroup.disabled || this.disabled;
    },
    labelStyle() {
      const styles = {};
      const fixWidth = this.radioGroup && this.radioGroup.fixWidth;

      if (fixWidth && typeof fixWidth !== 'boolean') {
        styles.width = `${fixWidth}px`;
        styles.maxWidth = `${fixWidth}px`;
        styles.minWidth = `${fixWidth}px`;
      }
      return styles;
    }
  },
  watch: {
    model(val) {
      if (!this.changeFromGroup) {
        // dispatch change event to radio-group with current value
        this.dispatch('ShopeeRadioGroup', 'radio-change', val);
      }
      this.changeFromGroup = false;
    },
    acturalValue(val) {
      this.model = val;
    }
  },
  created() {
    if (this.radioGroup) {
      this.$watch('radioGroup.value', val => {
        this.changeFromGroup = true;
        this.model = val;
      }, {
        immediate: true
      });
      this.$watch('currentValue', () => {
        this.model = this.radioGroup.value;
      });
    }
  },
  methods: {
    onChange() {
      const value = this.currentValue;
      this.model = value;
      this.$emit('input', value);
      this.$emit('change', value);
    }
  }
};
</script>
