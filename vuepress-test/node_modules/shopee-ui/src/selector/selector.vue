<template>
  <div class="shopee-selector"
    ref="selector"
    :class="className"
    @click="handlerClick()"
    @focus="handleFocus"
    @blur="handleBlur"
    tabindex="0">
    <div class="shopee-selector__prefix"
      v-if="prefixIcon"
      ref="prefix">
      <shopee-icon class="shopee-selector__prefix-icon" :svg="prefixIcon" v-if="prefixIcon"></shopee-icon>
    </div>
    <template v-if="multiple">
      <div class="shopee-selector--tags"
        :class="lineLimitClassName"
        :style="tagsMaxWidth ? {maxWidth: tagsMaxWidth + 'px'} : {}"
        v-if="currentValue && currentValue.length"
        ref="tags">
        <!-- <transition-group @after-leave="resetInputHeight">-->
          <shopee-selector-tag
            v-for="item in currentValue"
            :max-tag-text-width="maxTagTextWidth"
            :key="item.key"
            :text="item.label"
            @close="removeTag(item)">
          </shopee-selector-tag>
        <!--</transition-group> -->
      </div>
      <div v-else class="placeholder">{{placeholder}}</div>
    </template>
    <div class="shopee-selector__inner"
      v-else
      :class="innerClassName.concat(lineLimitClassName)">
      <slot></slot>
      <template v-if="!$slots.default">{{ !!currentValue ? currentValue : placeholder }}</template>
    </div>
    <div class="shopee-selector__suffix"
      v-if="suffixIcon || clearable"
      ref="suffix">
      <shopee-icon class="shopee-selector__clear-btn" :svg="clearIcon" v-if="clearable" @click.native.stop="handleClear()"></shopee-icon>
      <shopee-icon class="shopee-selector__suffix-icon" v-if="suffixIcon" :svg="suffixIcon"></shopee-icon>
    </div>
  </div>
</template>
<script>
import { Icon as ShopeeIcon } from 'shopee-ui/lib/icon';
import ShopeeSelectorTag from './selector-tag.vue';
import ROUND_CLOSE_SICON from '@/static/svg/icon-clear.svg';
import { EventBusMixin, FormItemMixin } from 'shopee-ui/lib/base';

export default {
  name: 'ShopeeSelector',
  components: {
    ShopeeIcon,
    ShopeeSelectorTag
  },
  mixins: [EventBusMixin, FormItemMixin],
  props: {
    clearable: {
      type: Boolean,
      default: false
    },
    multiple: {
      type: Boolean,
      default: false
    },
    placeholder: {
      type: String,
      default: ''
    },
    value: {
      type: [String, Array],
      default: ''
    },
    size: {
      type: String,
      validator(value = 'normal') {
        return ['large', 'normal', 'small'].indexOf(value) >= 0;
      }
    },
    maxLine: {
      type: Number,
      validator(value = 1) {
        return [1, 2, 3, 4, 5].indexOf(value) >= 0;
      },
      default: 1
    },
    maxTagTextWidth: {
      type: Number,
      default: 206
    },
    disabled: {
      type: Boolean,
      default: false
    },
    prefixIcon: String,
    suffixIcon: String,
    clearIcon: {
      type: String,
      default: ROUND_CLOSE_SICON
    }
  },
  data() {
    return {
      currentValue: this.value,
      focused: false,
      selectorWidth: 0
    };
  },
  computed: {
    className() {
      return [
        this.disabled ? 'disabled' : '',
        this.clearable ? 'clearable' : '',
        this.sizeClass ? `shopee-selector--${this.sizeClass}` : '',
        !this.disabled && this.clearable && this.currentValue && this.currentValue.length > 0 ? 'active-clearable' : '',
        this.multiple && this.currentValue && this.currentValue.length > 0 ? 'multiple' : ''
      ];
    },
    lineLimitClassName() {
      return [
        [1, 2, 3, 4, 5].indexOf(this.maxLine) >= 0 ? `line-clamp--${this.maxLine}` : 'line-clamp--1'
      ];
    },
    tagsMaxWidth() {
      return this.selectorWidth > 0 ? this.selectorWidth - 28 : 0;
    },
    innerClassName() {
      return [
        !this.currentValue && !!this.placeholder ? 'placeholder' : ''
      ];
    },

  },
  watch: {
    value(val) {
      this.setCurrentValue(val);
    }
  },
  mounted() {
    if (this.multiple) {
      const selector = this.$refs.selector;
      this.$nextTick(() => {
        if (selector) {
          this.selectorWidth = selector.getBoundingClientRect().width;
        }
      });
    }
  },
  methods: {
    setCurrentValue(value) {
      this.currentValue = value;
    },
    handlerClick() {
      this.$emit('click');
    },
    handleClear() {
      this.$emit('clear');
    },
    handleFocus() {
      this.focused = true;
      this.dispatch('ShopeeFormItem', 'field-focus');
    },
    handleBlur() {
      this.focused = false;
    },
    removeTag(item) {
      this.$emit('remove-tag' ,item);
    }
  }
};
</script>
